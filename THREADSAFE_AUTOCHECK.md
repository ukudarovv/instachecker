# ‚úÖ ThreadSafe –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ - –†–ï–ê–õ–ò–ó–û–í–ê–ù–û!

## üéØ **–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **–æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ** —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º event loop, –∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **–æ—Å–Ω–æ–≤–Ω–æ–π –ª—É–ø aiogram** - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

---

## üèóÔ∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è:**

### **1. ThreadSafeBotProxy** (`project/utils/bot_proxy.py`)
```python
class ThreadSafeBotProxy:
    """
    –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ –±–æ—Ç–æ–º –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ç–æ–∫–∞/–∏–≤–µ–Ω—Ç-–ª—É–ø–∞.
    –õ—é–±–æ–π async-–º–µ—Ç–æ–¥ (send_message, send_photo, ...) –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ª—É–ø.
    """
    def __init__(self, bot, main_loop: asyncio.AbstractEventLoop):
        self._bot = bot
        self._loop = main_loop

    async def _call(self, coro):
        # run_coroutine_threadsafe -> concurrent.futures.Future
        fut = asyncio.run_coroutine_threadsafe(coro, self._loop)
        # –¥–µ–ª–∞–µ–º await –≤ –¢–ï–ö–£–©–ï–ú (–ø–æ—Ç–æ–∫–æ–≤–æ–º) –ª—É–ø–µ
        return await asyncio.wrap_future(fut)
```

### **2. AsyncBotWrapper** (`project/utils/async_bot_wrapper.py`)
```python
class AsyncBotWrapper:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –Ω–∞—à–µ–≥–æ TelegramBot –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å ThreadSafeBotProxy.
    """
    async def send_message(self, chat_id: int, text: str, ...):
        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ aiohttp
        async with aiohttp.ClientSession() as session:
            async with session.post(url, json=data, timeout=10) as response:
                # ...
```

### **3. AutoCheckerThread** (`project/auto_checker_threaded.py`)
```python
class AutoCheckerThread:
    """
    –§–æ–Ω–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º asyncio-–ª—É–ø–æ–º.
    """
    def _thread_entry(self):
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            loop.run_until_complete(self._runner(loop))
        finally:
            loop.close()

    async def _runner(self, loop):
        # –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±–µ—Ä—Ç–∫—É –¥–ª—è –±–æ—Ç–∞
        async_bot = AsyncBotWrapper(self._bot_token)
        bot_proxy = ThreadSafeBotProxy(async_bot, self._main_loop)
        
        # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        while not self._stop.is_set():
            await asyncio.sleep(self._interval)
            await check_pending_accounts(self._SessionLocal, bot=bot_proxy, ...)
```

---

## üîß **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

### **1. –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ (bot.py):**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞
- –°–æ–∑–¥–∞–µ—Ç event loop –¥–ª—è ThreadSafe –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### **2. –ü–æ—Ç–æ–∫ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ (AutoCheckerThread):**
- –°–æ–∑–¥–∞–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π event loop
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ThreadSafeBotProxy –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### **3. ThreadSafeBotProxy:**
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç async-–∑–∞–ø—Ä–æ—Å—ã –∏–∑ –ø–æ—Ç–æ–∫–∞ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏
- –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–π event loop —á–µ—Ä–µ–∑ `run_coroutine_threadsafe`
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üìä **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**

### **1. –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç** –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –±–æ—Ç–∞
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏** —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ª—É–ø aiogram
- ‚úÖ **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π event loop** –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

### **2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –±–æ—Ç–∞
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫** –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### **3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- ‚úÖ **Graceful shutdown** –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- ‚úÖ **–ù–µ –≤–ª–∏—è–µ—Ç** –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞

---

## ‚è∞ **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:**

### **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:**
```
[INFO] Threaded auto-checker started (every 5 minutes)
[AUTO-CHECK/T] Initial run at 2025-10-10 18:30:00
[AUTO-CHECK/T] Initial run completed at 2025-10-10 18:35:00
```

### **–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:**
```
[AUTO-CHECK/T] Tick at 2025-10-10 18:35:00
```

**–ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:**
```
üîÑ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞

üìä –ê–∫–∫–∞—É–Ω—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ: 137
‚è∞ –í—Ä–µ–º—è: 18:35:00
```

**–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (~5 –º–∏–Ω—É—Ç):**
```
[AUTO-CHECK/T] Tick completed at 2025-10-10 18:40:00
```

**–ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –∏—Ç–æ–≥–∏:**
```
‚úÖ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: 137
‚Ä¢ –ù–∞–π–¥–µ–Ω–æ: 12
‚Ä¢ –ù–µ –Ω–∞–π–¥–µ–Ω–æ: 120
‚Ä¢ –û—à–∏–±–æ–∫: 5
```

---

## üéØ **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏:**

```
00:00 - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ + –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –í–°–ï–•
00:05 - –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö pending –∞–∫–∫–∞—É–Ω—Ç–æ–≤
00:10 - –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö pending –∞–∫–∫–∞—É–Ω—Ç–æ–≤
00:15 - –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö pending –∞–∫–∫–∞—É–Ω—Ç–æ–≤
00:20 - –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö pending –∞–∫–∫–∞—É–Ω—Ç–æ–≤
...
```

**–ß–∞—Å—Ç–æ—Ç–∞:** 12 —Ä–∞–∑ –≤ —á–∞—Å, 288 —Ä–∞–∑ –≤ –¥–µ–Ω—å

---

## üöÄ **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**

### **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–û—Ç–¥–µ–ª—å–Ω—ã–π event loop** –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ **ThreadSafe –æ—Ç–ø—Ä–∞–≤–∫–∏** —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ª—É–ø
- ‚úÖ **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏** SQLAlchemy

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- ‚úÖ **Try-catch** –≤ –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ **Graceful shutdown** –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** (3 –ø–æ—Ç–æ–∫–∞)
- ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP** –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤

---

## üìù **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ bot.py:**

```python
# –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π event loop
main_loop = asyncio.new_event_loop()
asyncio.set_event_loop(main_loop)

# –ó–∞–ø—É—Å–∫–∞–µ–º threaded auto-checker
_checker_thread = AutoCheckerThread(
    main_loop=main_loop,
    bot_token=settings.bot_token,
    SessionLocal=session_factory,
    interval_seconds=300,  # 5 –º–∏–Ω—É—Ç
    run_immediately=True,
)
_checker_thread.start()

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
while True:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # ...
```

---

## üéä **–ò–¢–û–ì:**

### **‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û:**
- ‚úÖ **ThreadSafe –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞** –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏** —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ª—É–ø aiogram
- ‚úÖ **–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç** –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –±–æ—Ç–∞
- ‚úÖ **Graceful shutdown** –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

### **üöÄ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê:**
- ü§ñ **–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞** –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- üì¨ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
- ‚ö° **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** (3 –ø–æ—Ç–æ–∫–∞)
- üîß **ThreadSafe –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- üõ°Ô∏è **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π event loop** –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

**–¢–µ–ø–µ—Ä—å –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç!** üéâüöÄ

---

## üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

### **–õ–æ–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```
[INFO] Threaded auto-checker started (every 5 minutes)
[AUTO-CHECK/T] Initial run at [–≤—Ä–µ–º—è]
[AUTO-CHECK/T] Tick at [–≤—Ä–µ–º—è] (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
[AUTO-CHECK/T] Tick completed at [–≤—Ä–µ–º—è]
```

### **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É:**
- **–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç** –æ –∑–∞–ø—É—Å–∫–µ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏
- **–ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

**–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã!** üìä
