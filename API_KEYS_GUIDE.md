# Руководство по работе с API ключами (RapidAPI)

## Обзор

Этап 5 добавляет функционал управления API ключами RapidAPI для проверки аккаунтов Instagram через сервис Instagram210 API.

## Возможности

### 1. Управление ключами

- **Просмотр ключей**: Список всех API ключей пользователя с информацией о статусе и использовании
- **Добавление ключа**: Добавление нового API ключа с автоматической валидацией
- **Удаление ключа**: Удаление неактуального ключа
- **Тестирование**: Проверка работоспособности ключа

### 2. Проверка аккаунтов

- **Массовая проверка**: Проверка всех аккаунтов на проверке через API
- **Автоматический выбор ключа**: Система выбирает лучший доступный ключ
- **Учет лимитов**: Уважение суточного лимита запросов (950 по умолчанию)

### 3. Фоновые задачи

- **Ежедневный сброс**: Счетчики использования обнуляются каждый день в 00:01

## Структура файлов

```
project/
├── services/
│   ├── api_keys.py           # Управление API ключами
│   └── check_via_api.py      # Проверка через API
├── handlers/
│   ├── api_menu.py           # Хендлеры меню API
│   └── check_via_api.py      # Хендлеры проверки
├── cron/
│   ├── __init__.py
│   └── schedule.py           # Фоновые задачи
└── config.py                 # Настройки (обновлен)
```

## Конфигурация

Добавьте в `.env`:

```env
# RapidAPI settings
RAPIDAPI_HOST=instagram210.p.rapidapi.com
RAPIDAPI_URL=https://instagram210.p.rapidapi.com/ig_profile
API_DAILY_LIMIT=950
RAPIDAPI_TIMEOUT_SECONDS=10
```

## Использование

### Через Telegram бот

1. **Открыть меню API**:
   - Нажмите кнопку "API" в главном меню

2. **Добавить ключ**:
   - Выберите "Добавить API ключ"
   - Отправьте ваш RapidAPI ключ
   - Система автоматически проверит его валидность

3. **Просмотреть ключи**:
   - Выберите "Мои API ключи"
   - Увидите список со статусами и счетчиками

4. **Проверить аккаунты**:
   - Выберите "Проверка через API (все)"
   - Система проверит все аккаунты на проверке

### Программный доступ

```python
from project.services.api_keys import pick_best_key, test_api_key
from project.services.check_via_api import check_account_exists_via_api

# Выбрать лучший ключ
with session_factory() as session:
    key = pick_best_key(session, user_id=123)
    
# Проверить ключ
ok, error = await test_api_key("your_key_here")

# Проверить аккаунт
result = await check_account_exists_via_api(session, user_id=123, username="instagram")
# result = {"username": "instagram", "exists": True, "error": None}
```

## Логика выбора ключа

Функция `pick_best_key()` выбирает ключ по следующим критериям:

1. Ключ должен быть помечен как рабочий (`is_work=True`)
2. Использование за сегодня меньше суточного лимита
3. Приоритет отдается ключу с наименьшим количеством использований

## Модель данных

```python
class APIKey(Base):
    id: int                    # ID ключа
    user_id: int              # ID пользователя
    key: str                  # Сам ключ (уникальный)
    qty_req: int              # Количество запросов за сегодня
    ref_date: DateTime        # Дата последнего сброса/обновления
    is_work: bool             # Флаг работоспособности
```

## Формат ответа API

При проверке через API возвращается:

```python
{
    "username": "имя_аккаунта",
    "exists": True | False | None,  # None = ошибка
    "error": None | "описание_ошибки"
}
```

## Cron задачи

### Сброс счетчиков (00:01 ежедневно)

```python
# Автоматически обнуляет qty_req для всех ключей
# Обновляет ref_date на текущую дату
```

## Обработка ошибок

- **Нет доступных ключей**: `error="no_available_api_key"`
- **Превышен лимит**: Ключ пропускается при выборе
- **Ошибка API**: Ключ остается рабочим (не помечается как нерабочий после одной ошибки)

## Тестирование

Для тестирования функционала:

1. Добавьте реальный RapidAPI ключ
2. Проверьте его через кнопку "Тест"
3. Попробуйте проверить аккаунт через "Проверка через API (все)"

## Безопасность

- API ключи хранятся в базе данных в открытом виде (при необходимости можно добавить шифрование)
- Доступ к ключам только у владельца (через `user_id`)
- Валидация ключей при добавлении

## Расширение

Для добавления новых провайдеров API:

1. Создайте новый модуль в `project/services/`
2. Реализуйте аналогичные функции проверки
3. Добавьте настройки в `config.py`
4. Обновите хендлеры для поддержки выбора провайдера

