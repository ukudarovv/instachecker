# ‚úÖ ThreadSafe –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–û!

## ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**

### **1. ImportError: attempted relative import with no known parent package**
```
ImportError: attempted relative import with no known parent package
```

### **2. –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–º–ø–æ—Ä—Ç–∞–º–∏ –º–æ–¥—É–ª–µ–π**
```
from .utils.bot_proxy import ThreadSafeBotProxy
from .utils.async_bot_wrapper import AsyncBotWrapper
from .cron.auto_checker import check_pending_accounts
```

---

## ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

### **1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã –≤ `auto_checker_threaded.py`:**

#### **–ë—ã–ª–æ:**
```python
from .utils.bot_proxy import ThreadSafeBotProxy
from .utils.async_bot_wrapper import AsyncBotWrapper
from .cron.auto_checker import check_pending_accounts
```

#### **–°—Ç–∞–ª–æ:**
```python
try:
    from .utils.bot_proxy import ThreadSafeBotProxy
    from .utils.async_bot_wrapper import AsyncBotWrapper
    from .cron.auto_checker import check_pending_accounts
except ImportError:
    from utils.bot_proxy import ThreadSafeBotProxy
    from utils.async_bot_wrapper import AsyncBotWrapper
    from cron.auto_checker import check_pending_accounts
```

### **2. –£–±—Ä–∞–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç –≤ `async_bot_wrapper.py`:**

#### **–ë—ã–ª–æ:**
```python
from aiogram import Bot
```

#### **–°—Ç–∞–ª–æ:**
```python
# –£–±—Ä–∞–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç aiogram
```

---

## üèóÔ∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ThreadSafe –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏:**

### **1. ThreadSafeBotProxy** (`project/utils/bot_proxy.py`)
- –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ç–æ–∫–∞
- –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç async-–º–µ—Ç–æ–¥—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–π event loop
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `run_coroutine_threadsafe`

### **2. AsyncBotWrapper** (`project/utils/async_bot_wrapper.py`)
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –Ω–∞—à–µ–≥–æ TelegramBot
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç aiohttp –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å ThreadSafeBotProxy

### **3. AutoCheckerThread** (`project/auto_checker_threaded.py`)
- –§–æ–Ω–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π asyncio event loop
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤

---

## üìä **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

### **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:**
```
[INFO] Threaded auto-checker started (every 5 minutes)
[AUTO-CHECK/T] Initial run at 2025-10-10 18:40:00
[AUTO-CHECK/T] Initial run completed at 2025-10-10 18:45:00
```

### **–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:**
```
[AUTO-CHECK/T] Tick at 2025-10-10 18:45:00
```

**–ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:**
```
üîÑ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞

üìä –ê–∫–∫–∞—É–Ω—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ: 137
‚è∞ –í—Ä–µ–º—è: 18:45:00
```

**–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
```
[AUTO-CHECK/T] Tick completed at 2025-10-10 18:50:00
```

**–ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –∏—Ç–æ–≥–∏:**
```
‚úÖ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: 137
‚Ä¢ –ù–∞–π–¥–µ–Ω–æ: 12
‚Ä¢ –ù–µ –Ω–∞–π–¥–µ–Ω–æ: 120
‚Ä¢ –û—à–∏–±–æ–∫: 5
```

---

## üéØ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ ThreadSafe –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**

### **1. –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç** –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –±–æ—Ç–∞
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏** —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π event loop
- ‚úÖ **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫** –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

### **2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –±–æ—Ç–∞
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫** –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤

### **3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- ‚úÖ **Graceful shutdown** –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- ‚úÖ **–ù–µ –≤–ª–∏—è–µ—Ç** –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞

---

## ‚è∞ **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:**

```
00:00 - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ + –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –í–°–ï–•
00:05 - –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö pending –∞–∫–∫–∞—É–Ω—Ç–æ–≤
00:10 - –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö pending –∞–∫–∫–∞—É–Ω—Ç–æ–≤
00:15 - –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö pending –∞–∫–∫–∞—É–Ω—Ç–æ–≤
00:20 - –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö pending –∞–∫–∫–∞—É–Ω—Ç–æ–≤
...
```

**–ß–∞—Å—Ç–æ—Ç–∞:** 12 —Ä–∞–∑ –≤ —á–∞—Å, 288 —Ä–∞–∑ –≤ –¥–µ–Ω—å

---

## üöÄ **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**

### **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–û—Ç–¥–µ–ª—å–Ω—ã–π event loop** –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ **ThreadSafe –æ—Ç–ø—Ä–∞–≤–∫–∏** —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ª—É–ø
- ‚úÖ **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏** SQLAlchemy

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- ‚úÖ **Try-catch** –≤ –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ **Graceful shutdown** –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** (3 –ø–æ—Ç–æ–∫–∞)
- ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP** –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤

---

## üìù **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ bot.py:**

```python
# –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π event loop
main_loop = asyncio.new_event_loop()
asyncio.set_event_loop(main_loop)

# –ó–∞–ø—É—Å–∫–∞–µ–º threaded auto-checker
_checker_thread = AutoCheckerThread(
    main_loop=main_loop,
    bot_token=settings.bot_token,
    SessionLocal=session_factory,
    interval_seconds=300,  # 5 –º–∏–Ω—É—Ç
    run_immediately=True,
)
_checker_thread.start()

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
while True:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # ...
```

---

## üéä **–ò–¢–û–ì:**

### **‚úÖ –ü–†–û–ë–õ–ï–ú–´ –†–ï–®–ï–ù–´:**
- ‚úÖ **ImportError** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã
- ‚úÖ **–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã** - –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ
- ‚úÖ **ThreadSafe –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ **–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç** - –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ

### **üöÄ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê:**
- ü§ñ **–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞** –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- üì¨ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
- ‚ö° **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** (3 –ø–æ—Ç–æ–∫–∞)
- üîß **ThreadSafe –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- üõ°Ô∏è **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π event loop** –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

**–¢–µ–ø–µ—Ä—å –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç!** üéâüöÄ

---

## üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

### **–õ–æ–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```
[INFO] Threaded auto-checker started (every 5 minutes)
[AUTO-CHECK/T] Initial run at [–≤—Ä–µ–º—è]
[AUTO-CHECK/T] Tick at [–≤—Ä–µ–º—è] (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
[AUTO-CHECK/T] Tick completed at [–≤—Ä–µ–º—è]
```

### **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É:**
- **–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç** –æ –∑–∞–ø—É—Å–∫–µ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏
- **–ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

**–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã!** üìä
