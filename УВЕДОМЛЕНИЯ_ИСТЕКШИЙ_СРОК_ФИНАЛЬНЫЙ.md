# Уведомления об истекшем сроке - Финальная версия

## Что изменилось

Уведомления об истекшем сроке мониторинга теперь содержат **оригинальный текст** + **интерактивные кнопки** под сообщением.

## Новый формат уведомления

### ✅ Финальная версия (с кнопками):

```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!

📅 Следующие аккаунты достигли конца периода мониторинга:
• @ukudarovvv (просрочен на 27 дн.)
• @peshkova_expert (просрочен на 305 дн.)
• @negastudio (просрочен на 135 дн.)

🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка

📱 Используйте кнопку 'Неактивные аккаунты' для управления

┌──────────────────────────────────┐
│ @ukudarovvv (просрочен на 27 дн.) │  ← КНОПКА!
├──────────────────────────────────┤
│ @peshkova_expert (просрочен на 305 дн.) │  ← КНОПКА!
├──────────────────────────────────┤
│ @negastudio (просрочен на 135 дн.) │  ← КНОПКА!
├──────────────────────────────────┤
│ 📱 Неактивные аккаунты           │  ← КНОПКА!
└──────────────────────────────────┘
```

### ❌ Было (только текст):
```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!

📅 Следующие аккаунты достигли конца периода мониторинга:
• @ukudarovvv (просрочен на 27 дн.)

🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка

📱 Используйте кнопку 'Неактивные аккаунты' для управления
```

## Функциональность кнопок

### 1. **Кнопки аккаунтов**
- Каждый просроченный аккаунт = отдельная кнопка
- Формат: `@username (просрочен на X дн.)`
- При нажатии → открывается карточка аккаунта

### 2. **Карточка аккаунта при нажатии**
```
👤 Аккаунт
• username: @ukudarovvv
• с: 2025-09-19
• период (дней): 30
• до: 2025-10-19
• осталось: -27
• статус: 🕒 На проверке / В работе

┌─────────┬──────────┐
│ ➕ День │ ➖ День │  ← КНОПКИ действий
├─────────┴──────────┤
│    🗑 Удалить       │  ← КНОПКА удаления
├────────────────────┤
│     ⬅ Назад        │  ← КНОПКА назад
└────────────────────┘
```

### 3. **Кнопка "Неактивные аккаунты"**
- Показывает полный список неактивных аккаунтов
- С пагинацией для удобной навигации

## Технические детали

### Изменённые файлы

#### 1. `project/services/expiry_notifications.py`

**Функция `send_expired_notification`**:
- Сохраняет **оригинальный формат текста**
- Добавляет **inline keyboard с кнопками** под текстом
- Каждый аккаунт = кнопка с callback `expiry_expired:{account_id}`

```python
async def send_expired_notification(bot, user: User, accounts: List[Account]):
    # Original message format (unchanged)
    message_lines = [
        "⚠️ <b>ВНИМАНИЕ: Истек срок мониторинга!</b>\n",
        "📅 Следующие аккаунты достигли конца периода мониторинга:"
    ]
    
    for acc in accounts:
        days_overdue = (date.today() - acc.to_date).days
        message_lines.append(
            f"• <a href='https://www.instagram.com/{acc.account}/'>@{acc.account}</a> "
            f"(просрочен на {days_overdue} дн.)"
        )
    
    message_lines.extend([
        "",
        "🔄 <b>Что делать:</b>",
        "1️⃣ Увеличить период мониторинга",
        "2️⃣ Удалить аккаунт из списка",
        "",
        "📱 Используйте кнопку 'Неактивные аккаунты' для управления"
    ])
    
    message = "\n".join(message_lines)
    
    # ADD BUTTONS UNDER THE MESSAGE
    keyboard = []
    for acc in accounts:
        days_overdue = (date.today() - acc.to_date).days
        button_text = f"@{acc.account} (просрочен на {days_overdue} дн.)"
        keyboard.append([{
            "text": button_text,
            "callback_data": f"expiry_expired:{acc.id}"
        }])
    
    keyboard.append([{
        "text": "📱 Неактивные аккаунты",
        "callback_data": "show_inactive_accounts"
    }])
    
    reply_markup = {"inline_keyboard": keyboard}
    await bot.send_message(user.id, message, reply_markup=reply_markup)
```

#### 2. `project/bot.py`

**Обработчик callback `expiry_expired:`**:
- Показывает карточку аккаунта при нажатии на кнопку
- Те же действия: добавить/убрать дни, удалить

```python
elif callback_data.startswith("expiry_soon:") or callback_data.startswith("expiry_expired:"):
    # Show account info from expiry notification
    acc_id = int(callback_data.split(":")[1])
    
    # Get account and show card with action buttons
    acc = get_account_by_id(s, acc_id)
    info_text = format_account_card(acc)
    
    keyboard = {
        "inline_keyboard": [
            [
                {"text": "➕ День", "callback_data": f"addd:{acc_id}"},
                {"text": "➖ День", "callback_data": f"subd:{acc_id}"}
            ],
            [{"text": "🗑 Удалить", "callback_data": f"delc:{acc_id}"}],
            [{"text": "⬅ Назад", "callback_data": "close_expiry_info"}]
        ]
    }
    
    self.edit_message_text(chat_id, message_id, info_text, keyboard)
```

## Callback схема

```
Уведомление об истекшем сроке
    ├─ Текст сообщения (оригинальный формат)
    └─ Inline Keyboard:
        ├─ @account1 (просрочен на X дн.) → expiry_expired:{id} → Карточка аккаунта
        ├─ @account2 (просрочен на Y дн.) → expiry_expired:{id} → Карточка аккаунта
        └─ 📱 Неактивные аккаунты → show_inactive_accounts → Список неактивных
```

## Примеры использования

### Пример 1: Продление просроченного аккаунта

1. **Получили уведомление** с текстом и кнопками
2. **Нажали на кнопку** `@ukudarovvv (просрочен на 27 дн.)`
3. **Увидели карточку** аккаунта с информацией
4. **Нажали `➕ День`**
5. **Ввели количество дней**: `30`
6. **Период продлён!** ✅

### Пример 2: Удаление просроченного аккаунта

1. **Нажали на кнопку** с просроченным аккаунтом
2. **Нажали `🗑 Удалить`**
3. **Подтвердили удаление**
4. **Аккаунт удалён!** ✅

### Пример 3: Просмотр всех неактивных

1. **Нажали `📱 Неактивные аккаунты`**
2. **Увидели список** всех неактивных аккаунтов
3. **Можно перелистывать** страницы

## Преимущества нового формата

✅ **Сохранён оригинальный текст** - привычный формат уведомления  
✅ **Добавлена интерактивность** - кнопки для быстрых действий  
✅ **Лучший UX** - не нужно искать аккаунты в меню  
✅ **Быстрые действия** - продлить/удалить прямо из уведомления  
✅ **Обратная совместимость** - текст остался прежним  

## Сравнение форматов

### ❌ Только текст (было):
```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!
📅 Следующие аккаунты достигли конца периода мониторинга:
• @ukudarovvv (просрочен на 27 дн.)
🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка
📱 Используйте кнопку 'Неактивные аккаунты' для управления
```

### ✅ Текст + кнопки (стало):
```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!
📅 Следующие аккаунты достигли конца периода мониторинга:
• @ukudarovvv (просрочен на 27 дн.)
🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка
📱 Используйте кнопку 'Неактивные аккаунты' для управления

┌──────────────────────────────────┐
│ @ukudarovvv (просрочен на 27 дн.) │  ← КНОПКА!
├──────────────────────────────────┤
│ 📱 Неактивные аккаунты           │  ← КНОПКА!
└──────────────────────────────────┘
```

## Тестирование

Для тестирования используйте:

```bash
# Тест уведомлений об истекшем сроке
python test_expired_notification.py
```

## Дата обновления

16 октября 2025

