# Уведомления об истекшем сроке с кнопками

## Что изменилось

Уведомления об истекшем сроке мониторинга теперь также содержат интерактивные кнопки для быстрого управления аккаунтами.

## Новая функциональность

### 1. Уведомление об истекшем сроке с кнопками

Вместо текстового списка просроченных аккаунтов, пользователь получает сообщение с кнопками:

```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!

📅 Найдено аккаунтов: 3

🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка

👇 Нажмите на кнопку с аккаунтом для управления:

┌──────────────────────────────────┐
│ @peshkova_expert (просрочен на 305 дн.) │  ← КНОПКА!
├──────────────────────────────────┤
│ @negastudio (просрочен на 135 дн.)      │  ← КНОПКА!
├──────────────────────────────────┤
│ @agathavegaofcc (просрочен на 74 дн.)   │  ← КНОПКА!
├──────────────────────────────────┤
│ 📱 Неактивные аккаунты           │  ← КНОПКА!
└──────────────────────────────────┘
```

### 2. Информация при нажатии на кнопку

При нажатии на кнопку с просроченным аккаунтом открывается **стандартная карточка аккаунта**:

```
👤 Аккаунт
• username: @peshkova_expert
• с: 2025-01-15
• период (дней): 30
• до: 2025-02-14
• осталось: -305
• статус: 🕒 На проверке / В работе

┌─────────┬──────────┐
│ ➕ День │ ➖ День │  ← КНОПКИ действий
├─────────┴──────────┤
│    🗑 Удалить       │  ← КНОПКА удаления
├────────────────────┤
│     ⬅ Назад        │  ← КНОПКА назад
└────────────────────┘
```

### 3. Действия с просроченными аккаунтами

Прямо из уведомления можно:
- ✅ **Продлить период** (кнопка "➕ День")
- ✅ **Сократить период** (кнопка "➖ День") 
- ✅ **Удалить аккаунт** (кнопка "🗑 Удалить")
- ✅ **Посмотреть все неактивные** (кнопка "📱 Неактивные аккаунты")

## Сравнение: До и После

### ❌ Было (текстовое уведомление):
```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!

📅 Следующие аккаунты достигли конца периода мониторинга:
• @peshkova_expert (просрочен на 305 дн.)
• @negastudio (просрочен на 135 дн.)
• @agathavegaofcc (просрочен на 74 дн.)

🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка

📱 Используйте кнопку 'Неактивные аккаунты' для управления
```

### ✅ Стало (интерактивное уведомление):
```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!

📅 Найдено аккаунтов: 3

🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка

👇 Нажмите на кнопку с аккаунтом для управления:

[🔘 @peshkova_expert (просрочен на 305 дн.)]
[🔘 @negastudio (просрочен на 135 дн.)]
[🔘 @agathavegaofcc (просрочен на 74 дн.)]
[📱 Неактивные аккаунты]
```

## Технические детали

### Изменённые файлы

#### 1. `project/services/expiry_notifications.py`

**Функция `send_expired_notification`**:
- Создаёт интерактивную клавиатуру вместо текстового списка
- Каждый просроченный аккаунт = отдельная кнопка с callback
- Формат callback: `expiry_expired:{account_id}`

```python
async def send_expired_notification(bot, user: User, accounts: List[Account]):
    # Header message
    message_lines = [
        "⚠️ <b>ВНИМАНИЕ: Истек срок мониторинга!</b>\n",
        f"📅 Найдено аккаунтов: {len(accounts)}\n",
        "🔄 <b>Что делать:</b>\n",
        "1️⃣ Увеличить период мониторинга\n",
        "2️⃣ Удалить аккаунт из списка\n",
        "👇 Нажмите на кнопку с аккаунтом для управления:"
    ]
    
    # Create inline keyboard with buttons for each account
    keyboard = []
    for acc in accounts:
        days_overdue = (date.today() - acc.to_date).days
        button_text = f"@{acc.account} (просрочен на {days_overdue} дн.)"
        keyboard.append([{
            "text": button_text,
            "callback_data": f"expiry_expired:{acc.id}"
        }])
    
    # Add "Manage accounts" button
    keyboard.append([{
        "text": "📱 Неактивные аккаунты",
        "callback_data": "show_inactive_accounts"
    }])
    
    reply_markup = {"inline_keyboard": keyboard}
    await bot.send_message(user.id, message, reply_markup=reply_markup)
```

#### 2. `project/bot.py`

**Обновлён обработчик callback**:

```python
elif callback_data.startswith("expiry_soon:") or callback_data.startswith("expiry_expired:"):
    # Show account info from expiry notification (both types)
    acc_id = int(callback_data.split(":")[1])
    
    # Same logic for both expiring soon and expired accounts
    # Shows account card with action buttons
```

## Callback схема

```
Уведомление об истекшем сроке
    ├─ expiry_expired:{acc_id} → Карточка аккаунта
    │   ├─ addd:{acc_id} → Добавить дни (FSM)
    │   ├─ subd:{acc_id} → Убрать дни (FSM)
    │   ├─ delc:{acc_id} → Удалить (подтверждение)
    │   └─ close_expiry_info → Закрыть/Удалить
    │
    └─ show_inactive_accounts → Список неактивных
        └─ iinfo:{acc_id} → Карточка аккаунта из списка
```

## Примеры использования

### Пример 1: Продление просроченного аккаунта

1. Получили уведомление о просроченных аккаунтах
2. Нажали на `@peshkova_expert (просрочен на 305 дн.)`
3. Увидели карточку аккаунта
4. Нажали `➕ День`
5. Ввели: `30`
6. Период продлён! ✅

### Пример 2: Удаление просроченного аккаунта

1. Нажали на кнопку с просроченным аккаунтом
2. Нажали `🗑 Удалить`
3. Подтвердили удаление
4. Аккаунт удалён! ✅

### Пример 3: Просмотр всех неактивных

1. Нажали `📱 Неактивные аккаунты`
2. Увидели список всех неактивных аккаунтов
3. Можно перелистывать страницы

## Типы уведомлений

### 1. Предупреждение (за 7 дней) - с кнопками
```
⏰ Напоминание: скоро истечет срок мониторинга

📅 Найдено аккаунтов: 2

💡 Рекомендация: Увеличьте период мониторинга заранее

👇 Нажмите на кнопку с аккаунтом для просмотра информации:

[🔘 @username1 (осталось 5 дн.)]
[🔘 @username2 (осталось 3 дн.)]
[📱 Неактивные аккаунты]
```

### 2. Истёк срок - с кнопками
```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!

📅 Найдено аккаунтов: 3

🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка

👇 Нажмите на кнопку с аккаунтом для управления:

[🔘 @username1 (просрочен на 5 дн.)]
[🔘 @username2 (просрочен на 10 дн.)]
[🔘 @username3 (просрочен на 27 дн.)]
[📱 Неактивные аккаунты]
```

## Преимущества

✅ **Удобство**: Вся информация в одном сообщении  
✅ **Быстрота**: Не нужно искать аккаунты в меню  
✅ **Наглядность**: Видно количество просроченных дней  
✅ **Действия**: Можно сразу продлить или удалить  
✅ **UX**: Современный интерфейс с inline кнопками  
✅ **Единообразие**: Одинаковый интерфейс для всех уведомлений  

## Обратная совместимость

✅ Все существующие callback обработчики работают без изменений  
✅ Стандартные меню бота не затронуты  
✅ Логика уведомлений сохранена, добавлена только интерактивность  

## Тестирование

Для тестирования используйте:

```bash
# Тест уведомлений о скором истечении (за 7 дней)
python test_send_to_me.py

# Тест уведомлений об истекшем сроке
python test_expired_notification.py

# Тест всех уведомлений
python test_expiry_notification.py
```

## Дата обновления

16 октября 2025

