# Обновление логики добавления аккаунтов

## Изменения

### 1. **Автоматический период 30 дней**
- ✅ Убрано поле ввода количества дней
- ✅ По умолчанию устанавливается 30 дней
- ✅ Упрощен процесс добавления аккаунта

### 2. **Автоматические уведомления об истечении срока**
- ✅ Уведомления за 3 дня до истечения
- ✅ Уведомления при истечении срока
- ✅ Предложение увеличить период или удалить аккаунт

## Детали изменений

### Функция создания аккаунта (`project/services/accounts.py`)

#### Было:
```python
def create_account(session: Session, user_id: int, username: str, days: int) -> Account:
```

#### Стало:
```python
def create_account(session: Session, user_id: int, username: str, days: int = 30) -> Account:
```

**Изменения:**
- Добавлен параметр по умолчанию `days: int = 30`
- Если дни не указаны, автоматически используется 30 дней

### Новые функции для уведомлений (`project/services/accounts.py`)

#### 1. Получение истекших аккаунтов
```python
def get_expired_accounts(session: Session) -> List[Account]:
    """Get accounts that have expired (to_date < today) and are not done."""
    return (
        session.query(Account)
        .filter(
            Account.done == False,
            Account.to_date < today_date
        )
        .order_by(Account.to_date.asc())
        .all()
    )
```

#### 2. Получение аккаунтов, истекающих скоро
```python
def get_accounts_expiring_soon(session: Session, days_ahead: int = 3) -> List[Account]:
    """Get accounts that will expire in the next N days."""
    return (
        session.query(Account)
        .filter(
            Account.done == False,
            Account.to_date >= today_date,
            Account.to_date <= future_date
        )
        .order_by(Account.to_date.asc())
        .all()
    )
```

### Новый сервис уведомлений (`project/services/expiry_notifications.py`)

#### Функции уведомлений:
1. **`check_and_send_expiry_notifications()`** - основная функция проверки
2. **`send_expired_notification()`** - уведомление об истекших аккаунтах
3. **`send_expiring_soon_notification()`** - уведомление о скором истечении
4. **`start_expiry_checker()`** - запуск периодической проверки

#### Пример уведомления об истечении:
```
⚠️ ВНИМАНИЕ: Истек срок мониторинга!

📅 Следующие аккаунты достигли конца периода мониторинга:
• @username1 (просрочен на 5 дн.)
• @username2 (просрочен на 2 дн.)

🔄 Что делать:
1️⃣ Увеличить период мониторинга
2️⃣ Удалить аккаунт из списка

📱 Используйте кнопку 'Активные аккаунты' для управления
```

#### Пример уведомления о скором истечении:
```
⏰ Напоминание: скоро истечет срок мониторинга

📅 Следующие аккаунты скоро достигнут конца периода:
• @username1 (осталось 2 дн.)
• @username2 (осталось 1 дн.)

💡 Рекомендация: Увеличьте период мониторинга заранее

📱 Используйте кнопку 'Активные аккаунты' для управления
```

### Обновление обработчика добавления (`project/handlers/accounts_add.py`)

#### Было:
```
🆔 Введите Instagram username (можно с @):
```

#### Стало:
```
🆔 Введите Instagram username (можно с @):

📅 Период мониторинга: 30 дней (по умолчанию)
ℹ️ После добавления аккаунт будет автоматически проверяться
```

### Интеграция в автопроверку (`project/cron/auto_checker.py`)

#### Добавлено в начало функции проверки:
```python
# First, check for expired accounts and send notifications
if bot:
    try:
        await check_and_send_expiry_notifications(SessionLocal, bot)
    except Exception as e:
        print(f"[AUTO-CHECK] Failed to check expiry notifications: {e}")
```

## Логика работы

### 1. Добавление аккаунта
```
Пользователь: "Добавить аккаунт"
Бот: "Введите Instagram username"
Пользователь: "username"
Бот: "Аккаунт добавлен на 30 дней"
```

### 2. Автоматические уведомления
```
За 3 дня до истечения:
Бот: "⏰ Напоминание: скоро истечет срок мониторинга"

В день истечения и после:
Бот: "⚠️ ВНИМАНИЕ: Истек срок мониторинга!"
```

### 3. Управление аккаунтами
Пользователь может:
- ✅ Увеличить период мониторинга
- ✅ Удалить аккаунт
- ✅ Просмотреть все аккаунты

## Преимущества новой логики

### ✅ Упрощение процесса
- Меньше полей для заполнения
- Быстрое добавление аккаунтов
- Стандартный период 30 дней

### ✅ Автоматические уведомления
- Пользователи не забывают продлевать
- Заблаговременные напоминания
- Четкие инструкции по действиям

### ✅ Лучшее управление
- Централизованная логика проверки
- Интеграция с автопроверкой
- Автоматическая очистка истекших аккаунтов

## Настройки

### Интервал проверки уведомлений
По умолчанию проверка происходит каждые 24 часа, но можно настроить:

```python
# В main() функции
start_expiry_checker(SessionLocal, bot, interval_hours=12)  # Каждые 12 часов
```

### Дни предупреждения
По умолчанию уведомления приходят за 3 дня, но можно изменить:

```python
# В get_accounts_expiring_soon()
get_accounts_expiring_soon(session, days_ahead=5)  # За 5 дней
```

## Тестирование

### Тест 1: Добавление аккаунта
1. Нажмите "Добавить аккаунт"
2. Введите username
3. Проверьте, что период = 30 дней

### Тест 2: Уведомления
1. Создайте аккаунт с периодом 1 день
2. Подождите истечения срока
3. Проверьте получение уведомления

### Тест 3: Автоматическая проверка
1. Проверьте логи на наличие:
```
[EXPIRY-CHECK] Checking for expired accounts...
[EXPIRY-CHECK] Found X expired accounts
[EXPIRY-CHECK] ✅ Sent expired notification to user X
```

## Миграция существующих аккаунтов

Существующие аккаунты не затронуты:
- ✅ Текущие периоды сохранены
- ✅ Дата окончания не изменилась
- ✅ Уведомления будут работать для всех аккаунтов

## Мониторинг

### Логи для отслеживания:
```bash
grep "EXPIRY-CHECK" /var/log/instagram-bot.log
grep "expired accounts" /var/log/instagram-bot.log
grep "expiring soon" /var/log/instagram-bot.log
```

### Статистика:
- Количество истекших аккаунтов
- Количество отправленных уведомлений
- Ошибки отправки уведомлений
