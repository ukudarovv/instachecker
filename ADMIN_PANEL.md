# ⚙️ Админ-панель

## Обзор

Админ-панель предоставляет администраторам расширенные возможности управления системой, включая настройку автопроверки и просмотр детальной статистики.

## Доступ

Админ-панель доступна только пользователям с ролью **администратор** (`role='admin'` или `role='superuser'`).

### Как попасть в админку:

1. Нажмите кнопку **"Админка"** в главном меню (видна только админам)
2. Откроется админское меню с доступными функциями

## Функции

### 1. ⏱ Интервал автопроверки

**Назначение:** Управление частотой автоматической проверки неактивных аккаунтов.

**Как использовать:**

1. Нажмите **"⏱ Интервал автопроверки"**
2. Увидите текущий интервал
3. Введите новый интервал в минутах (1-1440)
4. Получите подтверждение с расчетом производительности

**Пример диалога:**

```
[Админ] Нажимает "⏱ Интервал автопроверки"

[Бот] ⏱ **Интервал автопроверки**

Текущий интервал: **10 минут**

Введите новый интервал (в минутах):
• Минимум: 1 минута
• Максимум: 1440 минут (24 часа)
• Рекомендуемые: 5, 10, 15, 30

Или отправьте /cancel для отмены.

[Админ] 15

[Бот] ✅ **Интервал автопроверки обновлен!**

• Новый интервал: **15 минут**
• Проверок в час: ~4
• Проверок в день: ~96

⚠️ **Важно:** Для применения изменений перезапустите бота!
Текущая сессия использует старый интервал.
```

**Ограничения:**

- Минимальный интервал: **1 минута**
- Максимальный интервал: **1440 минут** (24 часа)

**Рекомендуемые значения:**

| Интервал | Описание | Проверок/час | Проверок/день |
|----------|----------|--------------|---------------|
| 1 мин | Очень агрессивная | ~60 | ~1440 |
| 5 мин | Агрессивная | ~12 | ~288 |
| **10 мин** | **Стандартная (рекомендуется)** | ~6 | ~144 |
| 15 мин | Сбалансированная | ~4 | ~96 |
| 30 мин | Экономичная | ~2 | ~48 |
| 60 мин | Редкая | ~1 | ~24 |

**⚠️ Важно:**

- Изменения сохраняются в базу данных
- Для применения нового интервала **необходимо перезапустить бота**
- Текущая сессия продолжит использовать старый интервал до перезапуска

---

### 2. 📊 Статистика системы

**Назначение:** Просмотр подробной статистики по всем компонентам системы.

**Как использовать:**

1. Нажмите **"📊 Статистика системы"**
2. Получите полный отчет

**Пример статистики:**

```
📊 **Статистика системы**

👥 **Пользователи:**
• Всего: 15
• Активных: 12

📱 **Аккаунты:**
• Всего: 237
• Найдено: 189
• На проверке: 48

🔑 **API ключи:**
• Всего: 8
• Рабочих: 7

🌐 **Прокси:**
• Всего: 5
• Активных: 4

📸 **IG-сессии:**
• Всего: 6
• Активных: 5

⏱ **Автопроверка:**
• Интервал: 10 мин
• Проверок/час: ~6
• Проверок/день: ~144
```

**Что показывается:**

- **Пользователи**: Общее количество и активные
- **Аккаунты**: Всего, найдено (done=True), на проверке (done=False)
- **API ключи**: Всего и рабочих (is_work=True)
- **Прокси**: Всего и активных (is_active=True)
- **IG-сессии**: Всего и активных (is_active=True)
- **Автопроверка**: Текущий интервал и расчетная производительность

---

## Навигация

Из админ-панели можно вернуться в главное меню:

- Нажмите **"Назад в меню"**

---

## Технические детали

### Хранение настроек

Настройки хранятся в таблице `system_settings`:

```sql
CREATE TABLE system_settings (
    id INTEGER PRIMARY KEY,
    key TEXT UNIQUE NOT NULL,
    value TEXT NOT NULL,
    updated_at TIMESTAMP
);
```

**Ключи настроек:**

- `auto_check_interval_minutes` - интервал автопроверки в минутах

### Сервисы

**`project/services/system_settings.py`:**

```python
# Получить настройку
get_setting(session, key, default=None)

# Установить настройку
set_setting(session, key, value)

# Получить интервал автопроверки
get_auto_check_interval(session)  # Returns: int (minutes)

# Установить интервал автопроверки
set_auto_check_interval(session, minutes)
```

### Модели

**`project/models.py`:**

```python
class SystemSettings(Base):
    __tablename__ = "system_settings"
    
    id = Column(Integer, primary_key=True)
    key = Column(String, unique=True, nullable=False, index=True)
    value = Column(String, nullable=False)
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
```

### Обработчики

**`project/handlers/admin_menu.py`:**

- `handle_admin_menu()` - Открытие админ-панели
- `handle_interval_menu()` - Меню изменения интервала
- `handle_interval_input()` - Обработка ввода нового интервала
- `handle_statistics()` - Отображение статистики

### FSM Состояния

**`project/states.py`:**

```python
class AdminStates(StatesGroup):
    waiting_for_interval = State()
```

---

## Безопасность

### Проверка прав доступа

Все админские функции защищены тремя уровнями проверки:

1. **`ensure_active(user)`** - пользователь активен
2. **`ensure_admin(user)`** - пользователь является админом
3. Кнопка "Админка" видна только админам

```python
if not ensure_active(user):
    return "⛔ Доступ пока не выдан."

if not ensure_admin(user):
    return "⛔ Доступ запрещен. Требуются права администратора."
```

### Назначение админов

Админские права назначаются в базе данных:

```sql
UPDATE users SET role = 'admin' WHERE id = <user_id>;
```

Или добавьте пользователя в `ADMIN_IDS` в `.env`:

```bash
ADMIN_IDS=123456789,987654321
```

---

## Примеры использования

### Сценарий 1: Увеличение частоты проверок

**Ситуация:** Нужно быстрее находить новые аккаунты.

**Решение:**

1. Админка → Интервал автопроверки
2. Введите `5` (5 минут)
3. Перезапустите бота

**Результат:** Проверка каждые 5 минут вместо 10.

---

### Сценарий 2: Снижение нагрузки

**Ситуация:** Бот использует слишком много ресурсов.

**Решение:**

1. Админка → Интервал автопроверки
2. Введите `30` (30 минут)
3. Перезапустите бота

**Результат:** Проверка каждые 30 минут, меньше нагрузки.

---

### Сценарий 3: Мониторинг системы

**Ситуация:** Нужно понять, как работает система.

**Решение:**

1. Админка → Статистика системы
2. Анализируйте данные

**Результат:** Полная картина состояния системы.

---

## Устранение проблем

### Кнопка "Админка" не отображается

**Причина:** У пользователя нет прав администратора.

**Решение:**

1. Проверьте роль пользователя в БД:
   ```sql
   SELECT role FROM users WHERE id = <user_id>;
   ```

2. Установите роль админа:
   ```sql
   UPDATE users SET role = 'admin' WHERE id = <user_id>;
   ```

---

### Изменения интервала не применяются

**Причина:** Бот не перезапущен после изменения.

**Решение:**

1. Остановите бота
2. Запустите снова:
   ```bash
   python project/bot.py
   ```

---

### Ошибка при вводе интервала

**Причина:** Неверный формат или значение вне диапазона.

**Решение:**

- Вводите целое число от 1 до 1440
- Используйте только цифры
- Или нажмите /cancel для отмены

---

## Расширение функционала

### Добавление новых настроек

1. Добавьте функции в `system_settings.py`:
   ```python
   def get_my_setting(session: Session) -> str:
       return get_setting(session, "my_setting_key", "default")
   
   def set_my_setting(session: Session, value: str):
       return set_setting(session, "my_setting_key", value)
   ```

2. Добавьте пункт в админ-меню (`keyboards.py`)

3. Создайте обработчик в `admin_menu.py`

4. Зарегистрируйте обработчик в `bot.py`

---

## Архитектура

```
┌─────────────────────────────────────┐
│        Главное меню                 │
│  (кнопка "Админка" для админов)     │
└─────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│        Админ-панель                 │
│  ⏱ Интервал автопроверки            │
│  📊 Статистика системы              │
│  Назад в меню                       │
└─────────────────────────────────────┘
               │
       ┌───────┴───────┐
       ▼               ▼
┌──────────────┐ ┌────────────────┐
│   Интервал   │ │  Статистика    │
│              │ │                │
│ 1. Текущий   │ │ • Пользователи │
│ 2. Ввод      │ │ • Аккаунты     │
│ 3. Валидация │ │ • API ключи    │
│ 4. Сохранение│ │ • Прокси       │
│ 5. Расчет    │ │ • IG-сессии    │
└──────────────┘ └────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│   SystemSettings (БД)                │
│   key: auto_check_interval_minutes   │
│   value: "10"                        │
└──────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│   Автопроверка (cron)                │
│   Читает интервал из БД              │
│   Запускает проверку каждые N минут  │
└──────────────────────────────────────┘
```

---

## Лучшие практики

1. **Регулярно проверяйте статистику** - помогает выявить проблемы
2. **Не устанавливайте слишком маленький интервал** - может привести к блокировкам
3. **Тестируйте изменения** - после изменения интервала наблюдайте за работой
4. **Ведите лог изменений** - записывайте какие настройки меняли и когда
5. **Резервное копирование** - делайте backup БД перед важными изменениями

---

## Готово к использованию!

Админ-панель полностью функциональна и готова к работе! 🎉

**Начните использовать прямо сейчас:**

1. Войдите в бота как администратор
2. Нажмите "Админка"
3. Настраивайте систему под свои нужды!

