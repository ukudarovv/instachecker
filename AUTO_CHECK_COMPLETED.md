# ✅ Автоматическая фоновая проверка - РЕАЛИЗОВАНА!

## 🎉 Что сделано

Реализована полноценная система автоматической фоновой проверки аккаунтов Instagram.

## 📋 Основные возможности

### 1. **Периодическая автопроверка**
- ⏰ Проверка каждые **10 минут** (настраивается)
- 🎯 Проверяет до **5 неактивных аккаунтов** за раз
- 🔄 Работает в фоновом режиме 24/7
- 📊 Подробное логирование всех операций

### 2. **Интеллектуальная обработка**
- 🔍 Использует гибридный метод (API + Instagram + скриншот)
- ✅ Автоматически помечает найденные аккаунты как `done=True`
- 📸 Делает и отправляет обрезанные скриншоты
- 🗑️ Автоматически удаляет скриншоты после отправки
- ⏱️ Задержка 5 секунд между проверками (защита от rate limit)

### 3. **Уведомления пользователям**
Когда аккаунт найден, пользователь автоматически получает:

```
🎉 Автопроверка!

✅ Аккаунт @username найден и активирован!
• Дата старта: 2025-10-10
• Период: 7 дней
```
+ Скриншот профиля

## 📁 Созданные файлы

### 1. `project/cron/auto_checker.py`
**Основная логика автопроверки:**
- `check_pending_accounts()` - проверка неактивных аккаунтов
- `start_auto_checker()` - запуск cron задачи
- Отправка уведомлений пользователям
- Управление скриншотами

**Функционал:**
```python
async def check_pending_accounts(SessionLocal, bot=None, max_accounts=5):
    # 1. Получить pending аккаунты (done=False)
    # 2. Для каждого:
    #    - Проверить наличие IG-сессии
    #    - Запустить hybrid check
    #    - Обновить статус если найден
    #    - Отправить уведомление + скриншот
    # 3. Вывести статистику
```

### 2. `project/cron/schedule.py` (обновлен)
**Интеграция автопроверки в cron:**
- Добавлен параметр `bot` для уведомлений
- Добавлен параметр `auto_check_interval`
- Запуск `start_auto_checker()`

### 3. `project/bot.py` (обновлен)
**Интеграция в main:**
```python
# Create bot first
bot = TelegramBot(settings.bot_token)

# Then start cron with bot instance
auto_check_interval = int(os.getenv("AUTO_CHECK_INTERVAL_MINUTES", "10"))
start_cron(session_factory, bot=bot, auto_check_interval=auto_check_interval)
```

### 4. `env.example` (обновлен)
**Новая настройка:**
```bash
# Auto-check settings
AUTO_CHECK_INTERVAL_MINUTES=10
```

### 5. `AUTO_CHECK_GUIDE.md`
Подробная документация по использованию автопроверки.

## ⚙️ Настройка

### Базовая конфигурация (`.env`)

```bash
# Интервал автопроверки в минутах
AUTO_CHECK_INTERVAL_MINUTES=10
```

### Рекомендуемые значения

| Интервал | Использование | Аккаунтов/час | Аккаунтов/день |
|----------|---------------|---------------|----------------|
| 5 мин    | Агрессивная проверка | ~60 | ~1440 |
| 10 мин   | **Стандартная** (по умолчанию) | ~30 | ~720 |
| 15 мин   | Экономичная | ~20 | ~480 |
| 30 мин   | Редкая | ~10 | ~240 |

### Расширенная настройка

В `project/cron/auto_checker.py` можно изменить:

```python
# Максимум аккаунтов за один запуск
max_accounts=5

# Задержка между проверками (секунды)
await asyncio.sleep(5)
```

## 🚀 Запуск

### 1. Обновите `.env` файл
```bash
AUTO_CHECK_INTERVAL_MINUTES=10  # или любое другое значение
```

### 2. Запустите бота
```bash
python project/bot.py
```

### 3. Проверьте логи
Вы должны увидеть:
```
[INFO] Cron jobs started (auto-check every 10 minutes)
[AUTO-CHECK] Started automatic checker (every 10 minutes)
```

### 4. Ждите первой проверки
Через N минут увидите:
```
[AUTO-CHECK] 2025-10-10 08:00:00 - Starting automatic check...
[AUTO-CHECK] Found 3 pending accounts to check.
[AUTO-CHECK] Checking @username1...
[AUTO-CHECK] ✅ @username1 - FOUND
...
[AUTO-CHECK] Completed!
  • Checked: 3
  • Found: 1
  • Not found: 1
  • Errors: 1
```

## 📊 Логирование

### Формат логов

```
[AUTO-CHECK] <timestamp> - Starting automatic check...
[AUTO-CHECK] Found N pending accounts to check.
[AUTO-CHECK] Checking @username...
[AUTO-CHECK] ✅ @username - FOUND          # Аккаунт найден
[AUTO-CHECK] ❌ @username - NOT FOUND      # Аккаунт не найден
[AUTO-CHECK] ❓ @username - ERROR: ...     # Ошибка проверки
[AUTO-CHECK] Skipping @username - no active IG session

[AUTO-CHECK] Completed!
  • Checked: X
  • Found: Y
  • Not found: Z
  • Errors: W
```

### Дополнительные логи

```
🗑️ Screenshot deleted: path/to/screenshot.png
📸 Screenshot saved: path/to/screenshot.png
✂️ Image cropped to upper half + center 60%
```

## 🔧 Архитектура

```
┌─────────────────────────────────────────┐
│         Bot Main Loop                   │
│         (Polling)                       │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│         Cron Scheduler                  │
│    (aiocron - асинхронный)              │
├─────────────────────────────────────────┤
│  • API counter reset (00:01 daily)      │
│  • Auto-checker (every N minutes)       │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│      Auto Checker                       │
│  (check_pending_accounts)               │
├─────────────────────────────────────────┤
│  1. Query pending accounts              │
│  2. For each (max 5):                   │
│     ├─ Get IG session                   │
│     ├─ hybrid_checker.check()           │
│     ├─ Update done=True if found        │
│     ├─ Send notification to user        │
│     ├─ Send screenshot                  │
│     └─ Delete screenshot                │
│  3. Log statistics                      │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│      Hybrid Checker                     │
│  (API + Instagram)                      │
├─────────────────────────────────────────┤
│  1. Try RapidAPI first                  │
│  2. If exists → Instagram screenshot    │
│  3. Crop screenshot                     │
│  4. Return result                       │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│         User Notification               │
│  (Telegram message + photo)             │
└─────────────────────────────────────────┘
```

## 🎯 Использование

### Пример workflow

1. **Пользователь добавляет аккаунты:**
   ```
   Добавить аккаунт → @username1 → 7 дней
   Добавить аккаунт → @username2 → 7 дней
   Добавить аккаунт → @username3 → 7 дней
   ```

2. **При добавлении:**
   - Сразу проверяется (instant check)
   - Если не найден → `done=False`

3. **Фоновая автопроверка:**
   - Каждые 10 минут проверяет неактивные
   - Когда находит → `done=True`
   - Отправляет уведомление пользователю

4. **Пользователь получает уведомление:**
   ```
   🎉 Автопроверка!
   ✅ Аккаунт @username2 найден и активирован!
   + скриншот
   ```

## 🛡️ Безопасность и производительность

### Защита от rate limiting
- ✅ Задержка 5 секунд между проверками
- ✅ Максимум 5 аккаунтов за раз
- ✅ Использует существующие безопасные сессии

### Оптимизация ресурсов
- ✅ Скриншоты удаляются после отправки
- ✅ Обрезанные скриншоты (меньше трафика)
- ✅ Асинхронная обработка (не блокирует бота)

### Надежность
- ✅ Обработка всех исключений
- ✅ Логирование ошибок
- ✅ Продолжение работы при ошибках

## 📈 Мониторинг

### Что отслеживать

1. **Логи автопроверки** - регулярность запусков
2. **Статистика** - процент успешных проверок
3. **Ошибки** - частота и типы ошибок
4. **IG-сессии** - актуальность cookies

### Команды для проверки

```sql
-- Неактивные аккаунты
SELECT COUNT(*) FROM accounts WHERE done = 0;

-- Активные сессии
SELECT COUNT(*) FROM instagram_sessions WHERE is_active = 1;

-- Статистика по пользователям
SELECT user_id, COUNT(*) as pending
FROM accounts
WHERE done = 0
GROUP BY user_id;
```

## 🔍 Устранение проблем

### Автопроверка не запускается
1. Проверьте переменную `AUTO_CHECK_INTERVAL_MINUTES` в `.env`
2. Посмотрите логи при запуске бота
3. Убедитесь что `aiocron` установлен

### Аккаунты не проверяются
1. Проверьте наличие активных IG-сессий
2. Проверьте API ключи (лимиты)
3. Увеличьте `max_accounts`

### Много ошибок
1. Проверьте качество IG-сессий (может нужно перелогиниться)
2. Проверьте интернет-соединение
3. Увеличьте timeout для проверок

## ✨ Преимущества

1. **Полностью автоматическая** - не требует действий пользователя
2. **24/7 работа** - проверяет постоянно
3. **Умные уведомления** - пользователь узнает сразу
4. **Экономия ресурсов** - скриншоты удаляются автоматически
5. **Масштабируемость** - настраиваемые интервалы и лимиты
6. **Надежность** - продолжает работать при ошибках

## 🎊 Готово к использованию!

Система полностью готова и работает автоматически после запуска бота!

**Запустите бота и наслаждайтесь автоматической проверкой!** 🚀
