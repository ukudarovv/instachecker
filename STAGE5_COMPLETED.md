# โ ะญัะฐะฟ 5 โ ะฃะฟัะฐะฒะปะตะฝะธะต API-ะบะปััะฐะผะธ (RapidAPI) โ ะะะะะะจะะ

## ะัะฟะพะปะฝะตะฝะฝัะต ะทะฐะดะฐัะธ

### 1. โ ะะฑะฝะพะฒะปะตะฝั ะฑะฐะทะพะฒัะต ะบะพะฝัะธะณััะฐัะธะธ

- **requirements.txt**: ะะพะฑะฐะฒะปะตะฝ `aiocron==1.8` ะดะปั ัะพะฝะพะฒัั ะทะฐะดะฐั
- **env.example**: ะะพะฑะฐะฒะปะตะฝั ะฟะฐัะฐะผะตััั RapidAPI:
  - `RAPIDAPI_HOST`
  - `RAPIDAPI_URL`
  - `API_DAILY_LIMIT` (950)
  - `RAPIDAPI_TIMEOUT_SECONDS` (10)
- **project/config.py**: ะะพะฑะฐะฒะปะตะฝั ะฝะฐัััะพะนะบะธ Settings ะดะปั RapidAPI

### 2. โ ะกะพะทะดะฐะฝั ัะตัะฒะธัั

#### project/services/api_keys.py
ะคัะฝะบัะธะพะฝะฐะป ัะฟัะฐะฒะปะตะฝะธั API ะบะปััะฐะผะธ:
- `list_keys_for_user()` - ัะฟะธัะพะบ ะบะปััะตะน ะฟะพะปัะทะพะฒะฐัะตะปั
- `pick_best_key()` - ะฒัะฑะพั ะปัััะตะณะพ ะดะพัััะฟะฝะพะณะพ ะบะปััะฐ
- `incr_usage()` - ะธะฝะบัะตะผะตะฝั ััะตััะธะบะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
- `set_work_status()` - ัััะฐะฝะพะฒะบะฐ ััะฐัััะฐ ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััะธ
- `test_api_key()` - ะฐัะธะฝััะพะฝะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต ะบะปััะฐ

#### project/services/check_via_api.py
ะัะพะฒะตัะบะฐ ะฐะบะบะฐัะฝัะพะฒ ัะตัะตะท RapidAPI:
- `check_account_exists_via_api()` - ะฐัะธะฝััะพะฝะฝะฐั ะฟัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ะฐะบะบะฐัะฝัะฐ
- ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ััะฐัััะฐ `done` ะดะปั ะฝะฐะนะดะตะฝะฝัั ะฐะบะบะฐัะฝัะพะฒ
- ะฃัะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะบะปััะตะน

### 3. โ ะะฑะฝะพะฒะปะตะฝั UI ะบะพะผะฟะพะฝะตะฝัั

#### project/keyboards.py
ะะพะฑะฐะฒะปะตะฝั ะบะปะฐะฒะธะฐัััั:
- `api_menu_kb()` - ะณะปะฐะฒะฝะพะต ะผะตะฝั API
- `api_key_card_kb(key_id)` - ะบะฐััะพัะบะฐ ะบะปััะฐ ั ะบะฝะพะฟะบะฐะผะธ ะดะตะนััะฒะธะน

#### project/states.py
ะะพะฑะฐะฒะปะตะฝะพ FSM ัะพััะพัะฝะธะต:
- `AddApiKeyStates.waiting_for_key` - ะพะถะธะดะฐะฝะธะต ะฒะฒะพะดะฐ ะบะปััะฐ

### 4. โ ะกะพะทะดะฐะฝั ัะตะฝะดะปะตัั

#### project/handlers/api_menu.py
ะะฑัะฐะฑะพััะธะบะธ ะผะตะฝั API (ะดะปั aiogram):
- ะัะบัััะธะต ะผะตะฝั API
- ะัะพัะผะพัั ะบะปััะตะน ะฟะพะปัะทะพะฒะฐัะตะปั
- ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒะพะณะพ ะบะปััะฐ ั ะฒะฐะปะธะดะฐัะธะตะน
- ะฃะดะฐะปะตะฝะธะต ะบะปััะฐ
- ะขะตััะธัะพะฒะฐะฝะธะต ะบะปััะฐ

#### project/handlers/check_via_api.py
ะะฑัะฐะฑะพััะธะบ ะผะฐััะพะฒะพะน ะฟัะพะฒะตัะบะธ:
- ะัะพะฒะตัะบะฐ ะฒัะตั ะฐะบะบะฐัะฝัะพะฒ ะฝะฐ ะฟัะพะฒะตัะบะต ัะตัะตะท API
- ะัะฒะพะด ัะตะทัะปััะฐัะพะฒ ั ะผะฐัะบะตัะฐะผะธ โ/โ/โ

### 5. โ ะคะพะฝะพะฒัะต ะทะฐะดะฐัะธ

#### project/cron/__init__.py
ะญะบัะฟะพัั ะผะพะดัะปั cron

#### project/cron/schedule.py
ะคะพะฝะพะฒะฐั ะทะฐะดะฐัะฐ:
- ะะถะตะดะฝะตะฒะฝัะน ัะฑัะพั ััะตััะธะบะพะฒ API ะฒ 00:01
- ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต `qty_req` ะธ `ref_date`

### 6. โ ะะฝัะตะณัะฐัะธั ะฒ ะฑะพั

#### project/bot.py
ะะพะฑะฐะฒะปะตะฝะพ:
- ะะผะฟะพัั ะผะพะดัะปั `start_cron`
- ะะฐะฟััะบ cron ะทะฐะดะฐั ะฟัะธ ััะฐััะต ะฑะพัะฐ
- ะะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธะน ะผะตะฝั API
- ะะฑัะฐะฑะพัะบะฐ FSM ัะพััะพัะฝะธั ะดะพะฑะฐะฒะปะตะฝะธั ะบะปััะฐ
- ะะฑัะฐะฑะพัะบะฐ callback queries ะดะปั ะดะตะนััะฒะธะน ั ะบะปััะฐะผะธ
- Inline ะพะฑัะฐะฑะพัะบะฐ ะฟัะพะฒะตัะบะธ ัะตัะตะท API

## Acceptance Criteria - ะัะฟะพะปะฝะตะฝั โ

### โ ะะฐะทะดะตะป ยซAPIยป ะฒ ะผะตะฝั
- โ ะะฝะพะฟะบะฐ ยซะะพะธ API ะบะปััะธยป - ะฟะพะบะฐะทัะฒะฐะตั ะบะฐััะพัะบะธ ั ะบะปััะฐะผะธ
- โ ะะฐัะบะธัะพะฒะฐะฝะธะต ะบะปััะตะน (ะฟะตัะฒัะต 4 + ... + ะฟะพัะปะตะดะฝะธะต 4 ัะธะผะฒะพะปะฐ)
- โ ะัะพะฑัะฐะถะตะฝะธะต `qty_req`, `ref_date`, `is_work`
- โ ะะฝะพะฟะบะธ ยซะฃะดะฐะปะธััยป ะธ ยซะขะตััยป ะฝะฐ ะบะฐะถะดะพะน ะบะฐััะพัะบะต

### โ ะะพะฑะฐะฒะปะตะฝะธะต API ะบะปััะฐ
- โ FSM ะดะปั ะฒะฒะพะดะฐ ะบะปััะฐ
- โ ะะฒัะพะผะฐัะธัะตัะบะฐั ะฒะฐะปะธะดะฐัะธั ะฟัะธ ะดะพะฑะฐะฒะปะตะฝะธะธ
- โ ะขะตััะพะฒัะน ะทะฐะฟัะพั ะบ API (ะฟัะพะฒะตัะบะฐ username="instagram")
- โ ะกะพััะฐะฝะตะฝะธะต ััะฐัััะฐ `is_work` ะฝะฐ ะพัะฝะพะฒะต ัะตะทัะปััะฐัะฐ ัะตััะฐ

### โ ะัะพะฒะตัะบะฐ ัะตัะตะท API
- โ ะะฝะพะฟะบะฐ ยซะัะพะฒะตัะบะฐ ัะตัะตะท API (ะฒัะต)ยป
- โ ะัะพะฒะตัะบะฐ ะฒัะตั ะฐะบะบะฐัะฝัะพะฒ ั `done=False`
- โ ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะฑะพั ะปัััะตะณะพ ะบะปััะฐ
- โ ะฃัะตั ัััะพัะฝะพะณะพ ะปะธะผะธัะฐ (`API_DAILY_LIMIT`)
- โ ะัะพััะฐะฒะปะตะฝะธะต `done=True` ะดะปั ะฝะฐะนะดะตะฝะฝัั ะฐะบะบะฐัะฝัะพะฒ

### โ ะคะพะฝะพะฒัะต ะทะฐะดะฐัะธ
- โ ะะถะตะดะฝะตะฒะฝัะน ัะฑัะพั ััะตััะธะบะพะฒ ะฒ 00:01
- โ ะะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ ะฟัะธ ััะฐััะต ะฑะพัะฐ

### โ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
- โ ะะพะฝััะฝัะต ัะพะพะฑัะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั
- โ ะัะณะบะฐั ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ API (ะฝะต ะฟะพะผะตัะฐะตะผ ะบะปัั ะบะฐะบ ะฝะตัะฐะฑะพัะธะน ะฟะพัะปะต ะพะดะฝะพะน ะพัะธะฑะบะธ)
- โ ะะพะทะฒัะฐั ััััะบัััะธัะพะฒะฐะฝะฝัั ะดะฐะฝะฝัั ั ะฟะพะปะตะผ `error`

### โ ะัะธะฝััะพะฝะฝะพััั
- โ ะะพะปะฝะพัััั ะฐัะธะฝััะพะฝะฝะฐั ัะฐะฑะพัะฐ ั API ัะตัะตะท `aiohttp`
- โ ะะธะบะฐะบะธั ะฑะปะพะบะธััััะธั `requests`
- โ ะะฝัะตะณัะฐัะธั ั `asyncio.run()` ะดะปั ัะธะฝััะพะฝะฝัั ะบะพะฝัะตะบััะพะฒ

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     Telegram Bot                        โ
โ                    (project/bot.py)                     โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
        โโโโโโโโโโโโโโดโโโโโโโโโโโโ
        โ                        โ
        โผ                        โผ
โโโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโ
โ   Handlers    โ        โ   Services   โ
โ  (api_menu,   โโโโโโโโโถโ  (api_keys,  โ
โ check_via_api)โ        โcheck_via_api)โ
โโโโโโโโโโโโโโโโโ        โโโโโโโโฌโโโโโโโโ
        โ                       โ
        โ                       โผ
        โ              โโโโโโโโโโโโโโโโโโโ
        โ              โ   RapidAPI      โ
        โ              โ (Instagram210)  โ
        โ              โโโโโโโโโโโโโโโโโโโ
        โ
        โผ
โโโโโโโโโโโโโโโโโโโโโโโโโ
โ    Database           โ
โ   (APIKey model)      โ
โ  - id, user_id        โ
โ  - key, qty_req       โ
โ  - ref_date, is_work  โ
โโโโโโโโโโโโโโโโโโโโโโโโโ
        โฒ
        โ
        โ
โโโโโโโโโดโโโโโโโโ
โ  Cron Tasks   โ
โ  (schedule.py)โ
โ  Reset daily  โ
โโโโโโโโโโโโโโโโโ
```

## ะะพะณะธะบะฐ ัะฐะฑะพัั

### 1. ะัะฑะพั ะปัััะตะณะพ ะบะปััะฐ
```python
pick_best_key(session, user_id) โ APIKey | None
# 1. ะคะธะปััั: is_work=True
# 2. ะคะธะปััั: qty_req < API_DAILY_LIMIT
# 3. ะกะพััะธัะพะฒะบะฐ: ะฟะพ qty_req (asc), ref_date (asc)
# 4. ะะพะทะฒัะฐั ะฟะตัะฒะพะณะพ ะฟะพะดัะพะดััะตะณะพ
```

### 2. ะัะพะฒะตัะบะฐ ะฐะบะบะฐัะฝัะฐ
```python
check_account_exists_via_api(session, user_id, username) โ dict
# 1. ะัะฑัะฐัั ะปัััะธะน ะบะปัั
# 2. ะกะดะตะปะฐัั ะทะฐะฟัะพั ะบ RapidAPI
# 3. ะะฝะบัะตะผะตะฝัะธัะพะฒะฐัั qty_req
# 4. ะะฐััะธะฝะณ ะพัะฒะตัะฐ (ัะฟะธัะพะบ[0].username == username)
# 5. ะัะปะธ ะฝะฐะนะดะตะฝ โ done=True, date_of_finish=today
# 6. ะะพะทะฒัะฐั {"username": str, "exists": bool|None, "error": str|None}
```

### 3. ะกะฑัะพั ััะตััะธะบะพะฒ
```python
@aiocron.crontab("1 0 * * *")
async def reset_api_counters():
    # ะะปั ะฒัะตั ะบะปััะตะน:
    # qty_req = 0
    # ref_date = datetime.utcnow()
```

## ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะะพะฑะฐะฒะปะตะฝะธะต ะบะปััะฐ
```
ะะพะปัะทะพะฒะฐัะตะปั: [ะฝะฐะถะธะผะฐะตั "ะะพะฑะฐะฒะธัั API ะบะปัั"]
ะะพั: ะัะธัะปะธัะต ะฒะฐั RapidAPI ะบะปัั (ัััะพะบะฐ).
ะะพะปัะทะพะฒะฐัะตะปั: abc123...xyz789
ะะพั: โณ ะัะพะฒะตััั ะบะปัั ัะตััะพะฒัะผ ะทะฐะฟัะพัะพะผ...
ะะพั: โ ะะปัั ะดะพะฑะฐะฒะปะตะฝ ะธ ะฒะฐะปะธะดะตะฝ (id=1).
```

### ะัะพัะผะพัั ะบะปััะตะน
```
ะะพะปัะทะพะฒะฐัะตะปั: [ะฝะฐะถะธะผะฐะตั "ะะพะธ API ะบะปััะธ"]
ะะพั:
๐ id=1
โข key: abc1...xyz9
โข is_work: โ
โข qty_req (ัะตะณะพะดะฝั): 47
โข ref_date: 2025-10-10 07:00:00
[ะฃะดะฐะปะธัั] [ะขะตัั]
```

### ะัะพะฒะตัะบะฐ ะฐะบะบะฐัะฝัะพะฒ
```
ะะพะปัะทะพะฒะฐัะตะปั: [ะฝะฐะถะธะผะฐะตั "ะัะพะฒะตัะบะฐ ัะตัะตะท API (ะฒัะต)"]
ะะพั: โณ ะัะพะฒะตััั ะฐะบะบะฐัะฝัั ัะตัะตะท RapidAPI...
ะะพั: โ @instagram โ ok
ะะพั: โ @nonexistent_user_12345 โ ok
ะะพั: โ @another_user โ timeout
ะะพั: ะะพัะพะฒะพ: ะฝะฐะนะดะตะฝะพ โ 1, ะฝะต ะฝะฐะนะดะตะฝะพ โ 1, ะฝะตะธะทะฒะตััะฝะพ โ 1.
```

## ะคะฐะนะปั ะดะพะบัะผะตะฝัะฐัะธะธ

- **API_KEYS_GUIDE.md** - ะฟะพะดัะพะฑะฝะพะต ััะบะพะฒะพะดััะฒะพ ะฟะพะปัะทะพะฒะฐัะตะปั
- **STAGE5_COMPLETED.md** - ััะพั ัะฐะนะป (ะพััะตั ะพ ะฒัะฟะพะปะฝะตะฝะธะธ)

## ะกะปะตะดัััะธะต ัะฐะณะธ

ะญัะฐะฟ 5 ะฟะพะปะฝะพัััั ะทะฐะฒะตััะตะฝ! ะะพะถะฝะพ ะฟะตัะตัะพะดะธัั ะบ:
- **ะญัะฐะฟ 6**: ะะดะผะธะฝ-ะฟะฐะฝะตะปั
- **ะญัะฐะฟ 7**: ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะปัััะตะฝะธั
- ะะปะธ ัะตััะธัะพะฒะฐะฝะธะต ัะตะบััะตะณะพ ััะฝะบัะธะพะฝะฐะปะฐ

## ะขะตััะธัะพะฒะฐะฝะธะต

ะะปั ะฟัะพะฒะตัะบะธ ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััะธ:

1. ะฃััะฐะฝะพะฒะธัะต ะทะฐะฒะธัะธะผะพััะธ: `pip install -r requirements.txt`
2. ะะฐัััะพะนัะต `.env` ั ะฟะฐัะฐะผะตััะฐะผะธ RapidAPI
3. ะะฐะฟัััะธัะต ะฑะพัะฐ: `python run_bot.py`
4. ะะพะปััะธัะต RapidAPI ะบะปัั ะฝะฐ https://rapidapi.com/
5. ะะพะฑะฐะฒััะต ะบะปัั ัะตัะตะท ะผะตะฝั ะฑะพัะฐ
6. ะะพะฑะฐะฒััะต ะฐะบะบะฐัะฝั ะฝะฐ ะฟัะพะฒะตัะบั
7. ะัะพะฒะตัััะต ัะตัะตะท "ะัะพะฒะตัะบะฐ ัะตัะตะท API (ะฒัะต)"

---

**ะกัะฐััั**: โ ะะฐะฒะตััะตะฝะพ  
**ะะฐัะฐ**: 2025-10-10  
**ะะตััะธั**: ะญัะฐะฟ 5

