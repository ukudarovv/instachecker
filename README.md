# Telegram Bot Project

Минимально-жизнеспособный каркас Telegram-бота с SQLite и SQLAlchemy, использующий прямые вызовы Telegram API.

## Технические требования

- Python 3.11+
- requests 2.31.0
- SQLAlchemy 2.0.32
- SQLite база данных
- Логирование с настраиваемым уровнем

## Установка и запуск

### 1. Создание виртуального окружения

```bash
make venv
```

### 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта и укажите ваш токен бота:

```
BOT_TOKEN=your_bot_token_here
ADMIN_IDS=123456789,987654321
DB_URL=sqlite:///bot.db
LOG_LEVEL=INFO
TZ=Asia/Aqtobe
```

### 3. Инициализация базы данных

```bash
make db
```

### 4. Запуск бота

```bash
make run
```

## Проверка работы

### Тестирование конфигурации

```bash
python test_bot.py
```

### Запуск бота

```bash
python run_bot.py
```

Или используйте Makefile:

```bash
make run
```

После запуска бота:

1. Отправьте команду `/start` боту
2. Если пользователь новый, будет создана запись в БД с `is_active=False`
3. Если пользователь активен, отобразится главное меню
4. Кнопка "Меню" также показывает главное меню

**Важно**: Не забудьте установить ваш реальный токен бота в файле `.env`!

## Структура проекта

```
project/
  __init__.py
  bot.py                  # entrypoint, executor.start_polling
  config.py               # загрузка env, фабрика Bot/Dispatcher, логгер, storage
  database.py             # engine, sessionmaker, Base.metadata.create_all
  models.py               # User, Account, API (минимально)
  handlers/
    __init__.py
    common.py             # /start, /menu
  keyboards.py            # Reply/Inline builders (минимум: главное меню)
  utils/
    __init__.py
    logging_setup.py      # единая точка настройки логов
  states.py               # (пока пустой каркас FSM)
```

## Дополнительные команды

- `make fmt` - форматирование кода (black + isort)
- `make db` - создание/проверка БД

## Функциональность

### Этап 1 - Меню и роли (RBAC)
- ✅ **Автосоздание пользователей** при первом `/start`
- ✅ **RBAC система** с ролями: `user`, `admin`, `superuser`
- ✅ **Система активации** - неактивные пользователи не видят меню
- ✅ **Главное меню** с базовыми функциями
- ✅ **Админ-панель** для пользователей с правами администратора
- ✅ **Проверка доступа** для всех операций
- ✅ **Чистые сообщения** об отказе в доступе

### Этап 2 - FSM "Добавить аккаунт"
- ✅ **Многошаговый FSM мастер** для добавления аккаунтов
- ✅ **Валидация username** - формат Instagram (буквы, цифры, точка, подчёркивание)
- ✅ **Ввод количества дней** - целое число > 0
- ✅ **Автоматический расчёт дат** - from_date, period, to_date
- ✅ **Защита от дублей** - проверка существующих аккаунтов
- ✅ **Кнопка "Отмена"** на каждом шаге FSM
- ✅ **Карточка успеха** с деталями добавленного аккаунта

### Этап 3 - Списки аккаунтов и управление
- ✅ **Списки аккаунтов** - "Активные аккаунты" и "Аккаунты на проверке"
- ✅ **Пагинация** - 15 записей на страницу с навигацией
- ✅ **Карточки аккаунтов** - детальная информация с remaining_days
- ✅ **Управление днями** - ➕/➖ дни с FSM вводом количества
- ✅ **Удаление аккаунтов** - с подтверждением через inline кнопки
- ✅ **Inline клавиатуры** - для навигации и управления
- ✅ **Защита доступа** - только владелец может управлять своими аккаунтами
- ✅ **Валидация операций** - не допускает period < 1 и to_date < from_date

### Этап 4 - Proxy-режим проверки аккаунтов
- ✅ **Модель Proxy** - полная телеметрия (used_count, success_count, fail_streak, cooldown)
- ✅ **Управление прокси** - добавление, редактирование, удаление, приоритеты
- ✅ **Проверка прокси** - тестирование подключения к Instagram через aiohttp-socks
- ✅ **Ротация прокси** - автоматический выбор лучшего доступного прокси
- ✅ **Проверка аккаунтов** - через прокси с ротацией и телеметрией
- ✅ **FSM добавления** - валидация URL формата, настройка приоритета
- ✅ **Кулдаун система** - автоматическое отключение неработающих прокси
- ✅ **Instagram probe** - проверка существования профилей через BeautifulSoup

### Основные возможности
- Регистрация пользователей при первом обращении
- Система активации пользователей администратором
- Главное меню с основными функциями
- Логирование всех операций
- Работа с SQLite базой данных через SQLAlchemy
