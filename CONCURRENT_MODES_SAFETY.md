# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏

## üîí –ö–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –∏–∑–±–µ–≥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### 1Ô∏è‚É£ **–ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ:

```python
# –í auto_checker.py
async def check_user_accounts(user_id: int, user_accounts: list, ...):
    """Check accounts for a specific user in a separate thread."""
    
    # –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
    with SessionLocal() as session:
        user = session.query(User).get(user_id)
        verify_mode = user.verify_mode or "api+instagram"
        
        # –†–µ–∂–∏–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ...
```

### 2Ô∏è‚É£ **–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã**

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã:

- **API –∫–ª—é—á–∏**: –ü—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `user_id`
- **Instagram —Å–µ—Å—Å–∏–∏**: –ü—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `user_id`
- **–ü—Ä–æ–∫—Å–∏**: –ü—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `user_id`

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
ig_session = get_priority_valid_session(session, user_id, fernet)
proxy = session.query(Proxy).filter(
    Proxy.user_id == user_id,
    Proxy.is_active == True
).first()
```

### 3Ô∏è‚É£ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**

–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ `asyncio.gather`:

```python
# –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
tasks = []
for user_id, user_accounts in accounts_by_user.items():
    task = check_user_accounts(user_id, user_accounts, SessionLocal, fernet, bot)
    tasks.append(task)

# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
results = await asyncio.gather(*tasks, return_exceptions=True)
```

### 4Ô∏è‚É£ **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤**

–ü–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤:

```python
# –î–ª—è —Ä–µ–∂–∏–º–æ–≤ —Å Instagram
if verify_mode in ["api+instagram", "instagram", "instagram+proxy", "api+proxy+instagram"]:
    ig_session = get_priority_valid_session(session, user_id, fernet)
    if not ig_session:
        print(f"[AUTO-CHECK] ‚ùå No valid IG session for user {user_id}")
        return {"checked": 0, "found": 0, "not_found": 0, "errors": len(user_accounts)}

# –î–ª—è —Ä–µ–∂–∏–º–æ–≤ —Å Proxy
if verify_mode in ["api+proxy", "proxy", "instagram+proxy", "api+proxy+instagram"]:
    proxy = session.query(Proxy).filter(
        Proxy.user_id == user_id,
        Proxy.is_active == True
    ).first()
    
    if not proxy:
        print(f"[AUTO-CHECK] ‚è≠Ô∏è User {user_id} has no active proxy - SKIPPING")
        return {"checked": 0, "found": 0, "not_found": 0, "errors": 0}
```

## üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A: api+instagram
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B: api+proxy
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å C: instagram+proxy
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- A –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–∏ API –∫–ª—é—á–∏ –∏ Instagram —Å–µ—Å—Å–∏—é
- B –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–∏ API –∫–ª—é—á–∏ –∏ –ø—Ä–æ–∫—Å–∏
- C –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ—é Instagram —Å–µ—Å—Å–∏—é –∏ –ø—Ä–æ–∫—Å–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ä–µ–∂–∏–º—ã, —Ä–∞–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A: api+proxy (Proxy 1)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B: api+proxy (Proxy 2)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å C: api+proxy (Proxy 3)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π –ø—Ä–æ–∫—Å–∏
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–∏ API –∫–ª—é—á–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A: api+proxy (–Ω–æ –Ω–µ—Ç –ø—Ä–æ–∫—Å–∏)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚è≠Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- –°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∏—Ç: `User A has no active proxy - SKIPPING`
- –î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç—É
- –û—à–∏–±–∫–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏—Ö

## üîç –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ `user_id`:

```sql
-- API Keys
CREATE TABLE api (
    id INTEGER PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    key TEXT UNIQUE NOT NULL,
    ...
);

-- Instagram Sessions
CREATE TABLE instagram_sessions (
    id INTEGER PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    username TEXT NOT NULL,
    ...
);

-- Proxies
CREATE TABLE proxies (
    id INTEGER PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    scheme TEXT NOT NULL,
    host TEXT NOT NULL,
    ...
);
```

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

- **asyncio.gather**: –ó–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **–û—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏**: –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–µ—Ç —Å–≤–æ—é database session
- **–ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫**: `return_exceptions=True` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã–µ –æ—à–∏–±–∫–∏

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å `user_id`:

```
[AUTO-CHECK] üßµ Starting check for user 1972775559 with 2 accounts
[AUTO-CHECK] üë§ User 1972775559 mode: api+instagram
[AUTO-CHECK] üì° Phase 1: API checks for user 1972775559...
```

## ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã
2. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å**: –û—à–∏–±–∫–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏—Ö
3. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**: –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏
5. **Graceful degradation**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:

```bash
python test_concurrent_modes.py
```

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- –ù–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ —É –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤
- –í–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–í –ª–æ–≥–∞—Ö –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- –ö–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —Å –∫–∞–∫–∏–º —Ä–µ–∂–∏–º–æ–º –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- –ö–∞–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- –ö–∞–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:

```
[AUTO-CHECK] üßµ Starting check for user 911484504 with 31 accounts
[AUTO-CHECK] üë§ User 911484504 mode: api+proxy
[AUTO-CHECK] ‚è≠Ô∏è User 911484504 has no active proxy - SKIPPING

[AUTO-CHECK] üßµ Starting check for user 1972775559 with 2 accounts
[AUTO-CHECK] üë§ User 1972775559 mode: api+instagram
[AUTO-CHECK] üì° Phase 1: API checks for user 1972775559...
```

## üéØ –í—ã–≤–æ–¥

–°–∏—Å—Ç–µ–º–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π —Ä–µ–∂–∏–º
- ‚úÖ –†–µ—Å—É—Ä—Å—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –ø–æ user_id
- ‚úÖ –û—à–∏–±–∫–∏ –Ω–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—é—Ç—Å—è
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞

