# ะะตะฐะปะธะทะฐัะธั ะณะธะฑัะธะดะฝะพะน ะฟัะพะฒะตัะบะธ (API + Instagram + ะกะบัะธะฝัะพัั)

## โ ะัะฟะพะปะฝะตะฝะพ

### 1. ะกะพะทะดะฐะฝ ัะตัะฒะธั ะณะธะฑัะธะดะฝะพะน ะฟัะพะฒะตัะบะธ

**ะคะฐะนะป**: `project/services/hybrid_checker.py`

#### ะคัะฝะบัะธะธ:

##### `check_account_hybrid()`
ะัะฝะพะฒะฝะฐั ััะฝะบัะธั ะณะธะฑัะธะดะฝะพะน ะฟัะพะฒะตัะบะธ:
```python
async def check_account_hybrid(
    session: Session,
    user_id: int,
    username: str,
    ig_session: Optional[InstagramSession] = None,
    fernet: Optional[OptionalFernet] = None
) -> Dict[str, Any]
```

**ะะปะณะพัะธัะผ**:
1. ะัะพะฒะตัะบะฐ ัะตัะตะท API (`check_account_exists_via_api`)
2. ะัะปะธ API ะฝะตะดะพัััะฟะตะฝ โ fallback ะฝะฐ Instagram
3. ะัะปะธ ะฝะฐะนะดะตะฝ ัะตัะตะท API โ ะฟะพะปััะตะฝะธะต ัะบัะธะฝัะพัะฐ ัะตัะตะท Instagram
4. ะะฑัะตะดะธะฝะตะฝะธะต ัะตะทัะปััะฐัะพะฒ

**ะะพะทะฒัะฐัะฐะตะผะฐั ััััะบัััะฐ**:
```python
{
    "username": str,
    "exists": bool | None,
    "full_name": str | None,
    "followers": int | None,
    "following": int | None,
    "posts": int | None,
    "screenshot_path": str | None,
    "error": str | None,
    "checked_via": str  # "api", "api+instagram", "instagram_only"
}
```

##### `check_multiple_accounts_hybrid()`
ะะฐััะพะฒะฐั ะฟัะพะฒะตัะบะฐ ะฝะตัะบะพะปัะบะธั ะฐะบะบะฐัะฝัะพะฒ ั ะพะฑัะฐะฑะพัะบะพะน ะพัะธะฑะพะบ ะดะปั ะบะฐะถะดะพะณะพ.

### 2. ะกะพะทะดะฐะฝ ัะตะฝะดะปะตั ะดะปั ะณะธะฑัะธะดะฝะพะน ะฟัะพะฒะตัะบะธ

**ะคะฐะนะป**: `project/handlers/check_hybrid.py`

#### ะคัะฝะบัะธะธ:

##### `register_check_hybrid_handlers()`
ะะตะณะธัััะธััะตั ัะตะฝะดะปะตัั ะดะปั aiogram:
- ะะฑัะฐะฑะพััะธะบ ัะพะพะฑัะตะฝะธั "ะัะพะฒะตัะบะฐ (API + ัะบัะธะฝัะพั)"
- ะะฐััะพะฒะฐั ะฟัะพะฒะตัะบะฐ ะฒัะตั pending ะฐะบะบะฐัะฝัะพะฒ
- ะัะฟัะฐะฒะบะฐ ัะตะบััะพะฒัั ัะตะทัะปััะฐัะพะฒ ะธ ัะบัะธะฝัะพัะพะฒ
- ะัะพะณะพะฒะฐั ััะฐัะธััะธะบะฐ

### 3. ะะฑะฝะพะฒะปะตะฝะฐ ะบะปะฐะฒะธะฐัััะฐ API ะผะตะฝั

**ะคะฐะนะป**: `project/keyboards.py`

ะะพะฑะฐะฒะปะตะฝะฐ ะบะฝะพะฟะบะฐ:
```python
[{"text": "ะัะพะฒะตัะบะฐ (API + ัะบัะธะฝัะพั)"}]
```

### 4. ะะฝัะตะณัะธัะพะฒะฐะฝะพ ะฒ ะฑะพั

**ะคะฐะนะป**: `project/bot.py`

#### ะะทะผะตะฝะตะฝะธั:

1. ะะพะฑะฐะฒะปะตะฝะฐ ะพะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ "ะัะพะฒะตัะบะฐ (API + ัะบัะธะฝัะพั)"
2. Inline ะพะฑัะฐะฑะพัะบะฐ ะณะธะฑัะธะดะฝะพะน ะฟัะพะฒะตัะบะธ:
   - ะะพะปััะตะฝะธะต ะฐะบะบะฐัะฝัะพะฒ ะฝะฐ ะฟัะพะฒะตัะบะต
   - ะะพะปััะตะฝะธะต Instagram ัะตััะธะธ
   - ะัะทะพะฒ `check_account_hybrid` ะดะปั ะบะฐะถะดะพะณะพ
   - ะัะฟัะฐะฒะบะฐ ัะตะทัะปััะฐัะพะฒ ั ัะพัะผะฐัะธัะพะฒะฐะฝะธะตะผ
   - ะัะฟัะฐะฒะบะฐ ัะบัะธะฝัะพัะพะฒ

3. ะะฑัะฐะฑะพัะบะฐ ะพััััััะฒะธั IG-ัะตััะธะธ:
```python
elif not ig_session:
    self.send_message(chat_id,
        "โ๏ธ ะะตั ะฐะบัะธะฒะฝะพะน Instagram-ัะตััะธะธ ะดะปั ัะบัะธะฝัะพัะพะฒ.\n"
        "ะัะดะตั ะฒัะฟะพะปะฝะตะฝะฐ ัะพะปัะบะพ ะฟัะพะฒะตัะบะฐ ัะตัะตะท API.\n"
        "ะะพะฑะฐะฒััะต IG-ัะตััะธั ัะตัะตะท ะผะตะฝั 'Instagram' ะดะปั ะฟะพะปััะตะฝะธั ัะบัะธะฝัะพัะพะฒ."
    )
```

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   Telegram Bot                          โ
โ                  (project/bot.py)                       โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  check_account_hybrid  โ
        โ (hybrid_checker.py)    โ
        โโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                 โ
      โโโโโโโโโโโโดโโโโโโโโโโโ
      โ                     โ
      โผ                     โผ
โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ
โ check_via_api  โ  โ check_with_      โ
โ (RapidAPI)     โ  โ screenshot       โ
โ                โ  โ (Playwright +    โ
โ - ะััััะพ       โ  โ  Instagram)      โ
โ - ะกััะตััะฒัะตั?  โ  โ                  โ
โ                โ  โ - ะะตัะฐะปะธ         โ
โ                โ  โ - ะกะบัะธะฝัะพั       โ
โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ
```

## ะะพะณะธะบะฐ ัะฐะฑะพัั

### ะกัะตะฝะฐัะธะน 1: ะะบะบะฐัะฝั ัััะตััะฒัะตั, ะตััั IG-ัะตััะธั

```
User: [ะัะพะฒะตัะบะฐ (API + ัะบัะธะฝัะพั)]
  โ
Bot: โณ ะัะพะฒะตััั ัะตัะตะท API + Instagram...
  โ
1. API Check โ โ Exists
  โ
2. Instagram Check โ Get details + screenshot
  โ
Bot: โ @username
     ะะผั: Full Name
     ะะพะดะฟะธััะธะบะธ: 1,234
     ะะพะดะฟะธัะบะธ: 567
     ะะพััั: 89
     ๐ ะัะพะฒะตัะตะฝะพ: API + Instagram
     [๐ธ ะกะบัะธะฝัะพั]
```

### ะกัะตะฝะฐัะธะน 2: ะะบะบะฐัะฝั ะฝะต ัััะตััะฒัะตั

```
User: [ะัะพะฒะตัะบะฐ (API + ัะบัะธะฝัะพั)]
  โ
Bot: โณ ะัะพะฒะตััั ัะตัะตะท API + Instagram...
  โ
1. API Check โ โ Not exists
  โ
2. Skip Instagram (ัะบะพะฝะพะผะธะผ ะฒัะตะผั)
  โ
Bot: โ @username
     ๐ ะัะพะฒะตัะตะฝะพ: API
```

### ะกัะตะฝะฐัะธะน 3: API ะฝะตะดะพัััะฟะตะฝ, ะตััั IG-ัะตััะธั

```
User: [ะัะพะฒะตัะบะฐ (API + ัะบัะธะฝัะพั)]
  โ
Bot: โณ ะัะพะฒะตััั ัะตัะตะท API + Instagram...
  โ
1. API Check โ โ Error (no_available_api_key)
  โ
2. Fallback to Instagram only
  โ
Bot: โ @username
     ะะผั: Full Name
     ๐ ะัะพะฒะตัะตะฝะพ: Instagram
     [๐ธ ะกะบัะธะฝัะพั]
```

### ะกัะตะฝะฐัะธะน 4: ะะตั IG-ัะตััะธะธ

```
User: [ะัะพะฒะตัะบะฐ (API + ัะบัะธะฝัะพั)]
  โ
Bot: โ๏ธ ะะตั ะฐะบัะธะฒะฝะพะน Instagram-ัะตััะธะธ ะดะปั ัะบัะธะฝัะพัะพะฒ.
     ะัะดะตั ะฒัะฟะพะปะฝะตะฝะฐ ัะพะปัะบะพ ะฟัะพะฒะตัะบะฐ ัะตัะตะท API.
     ะะพะฑะฐะฒััะต IG-ัะตััะธั ัะตัะตะท ะผะตะฝั 'Instagram'...
```

## ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ

### ะขะตะบััะพะฒะพะต ัะพะพะฑัะตะฝะธะต
```python
mark = "โ" if exists else ("โ" if not exists else "โ")
lines = [f"{mark} @{username}"]

if full_name:
    lines.append(f"ะะผั: {full_name}")
if followers is not None:
    lines.append(f"ะะพะดะฟะธััะธะบะธ: {followers:,}")
if following is not None:
    lines.append(f"ะะพะดะฟะธัะบะธ: {following:,}")
if posts is not None:
    lines.append(f"ะะพััั: {posts:,}")

check_via = result.get("checked_via")
if check_via == "api+instagram":
    lines.append("๐ ะัะพะฒะตัะตะฝะพ: API + Instagram")
elif check_via == "api":
    lines.append("๐ ะัะพะฒะตัะตะฝะพ: API")
elif check_via == "instagram_only":
    lines.append("๐ ะัะพะฒะตัะตะฝะพ: Instagram")

if error:
    lines.append(f"โ๏ธ {error}")
```

### ะกะบัะธะฝัะพั
ะัะฟัะฐะฒะปัะตััั ะพัะดะตะปัะฝัะผ ัะพะพะฑัะตะฝะธะตะผ ั caption:
```python
if screenshot_path and os.path.exists(screenshot_path):
    send_photo(screenshot_path, caption=f"๐ธ ะกะบัะธะฝัะพั @{username}")
```

## ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

### ะะฐะผะตัั ะฒัะตะผะตะฝะธ (ะฟัะธะผะตัะฝัะต):

| ะกัะตะฝะฐัะธะน | API | Instagram | ะัะพะณะพ |
|----------|-----|-----------|-------|
| ะะต ัััะตััะฒัะตั | 1 ัะตะบ | - | **1 ัะตะบ** |
| ะกััะตััะฒัะตั + IG | 1 ัะตะบ | 5-10 ัะตะบ | **6-11 ัะตะบ** |
| ะขะพะปัะบะพ Instagram | - | 5-10 ัะตะบ | **5-10 ัะตะบ** |

### ะญะบะพะฝะพะผะธั ะฒัะตะผะตะฝะธ ะดะปั 100 ะฐะบะบะฐัะฝัะพะฒ:

**ะขัะฐะดะธัะธะพะฝะฝัะน ะฟะพะดัะพะด (ัะพะปัะบะพ Instagram)**:
- 100 ร 7 ัะตะบ = **700 ัะตะบ** (~12 ะผะธะฝัั)

**ะะธะฑัะธะดะฝัะน ะฟะพะดัะพะด (50% ัััะตััะฒััั)**:
- 50 ร 1 ัะตะบ (ะฝะต ัััะตััะฒััั) = 50 ัะตะบ
- 50 ร 7 ัะตะบ (ัััะตััะฒััั) = 350 ัะตะบ
- **ะัะพะณะพ: 400 ัะตะบ** (~7 ะผะธะฝัั)
- **ะญะบะพะฝะพะผะธั: 43%**

## ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ

### ะขะธะฟั ะพัะธะฑะพะบ:

1. **`no_available_api_key`** - ะะตั ะดะพัััะฟะฝัั API ะบะปััะตะน
   - ะะตะนััะฒะธะต: Fallback ะฝะฐ Instagram

2. **`api_failed_no_ig_session`** - API ะฝะตะดะพัััะฟะตะฝ ะธ ะฝะตั IG-ัะตััะธะธ
   - ะะตะนััะฒะธะต: ะะพะทะฒัะฐั ะพัะธะฑะบะธ

3. **`screenshot_error: ...`** - ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ัะบัะธะฝัะพัะฐ
   - ะะตะนััะฒะธะต: ะะพะทะฒัะฐั ัะตะทัะปััะฐัะฐ API ะฑะตะท ัะบัะธะฝัะพัะฐ

4. **`instagram_error: ...`** - ะัะธะฑะบะฐ Instagram ะฟัะพะฒะตัะบะธ
   - ะะตะนััะฒะธะต: ะะพะทะฒัะฐั ะพัะธะฑะบะธ

## ะขะตััะธัะพะฒะฐะฝะธะต

### ะััะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต:

```bash
# 1. ะะฐะฟัััะธัั ะฑะพัะฐ
python run_bot.py

# 2. ะ Telegram:
# - ะัะบัััั ะผะตะฝั "API"
# - ะะพะฑะฐะฒะธัั API ะบะปัั
# - ะะพะฑะฐะฒะธัั Instagram ัะตััะธั
# - ะะพะฑะฐะฒะธัั ะฝะตัะบะพะปัะบะพ ะฐะบะบะฐัะฝัะพะฒ (ัััะตััะฒัััะธะต ะธ ะฝะตั)
# - ะะฐะถะฐัั "ะัะพะฒะตัะบะฐ (API + ัะบัะธะฝัะพั)"
# - ะัะพะฒะตัะธัั ัะตะทัะปััะฐัั ะธ ัะบัะธะฝัะพัั
```

### ะัะพะฒะตัะบะฐ ะณัะฐะฝะธัะฝัั ัะปััะฐะตะฒ:

1. โ ะะบะบะฐัะฝั ัััะตััะฒัะตั, ะตััั IG-ัะตััะธั
2. โ ะะบะบะฐัะฝั ะฝะต ัััะตััะฒัะตั
3. โ API ะฝะตะดะพัััะฟะตะฝ
4. โ IG-ัะตััะธั ะฝะตะดะพัััะฟะฝะฐ
5. โ ะะฑะฐ ะฝะตะดะพัััะฟะฝั
6. โ ะัะธะฒะฐัะฝัะน ะฐะบะบะฐัะฝั
7. โ ะัะธะฑะบะฐ ะฟัะธ ะฟะพะปััะตะฝะธะธ ัะบัะธะฝัะพัะฐ

## ะะฐััะธัะตะฝะธะต ััะฝะบัะธะพะฝะฐะปะฐ

### ะะพะฑะฐะฒะปะตะฝะธะต ะบััะธัะพะฒะฐะฝะธั:

```python
# ะ hybrid_checker.py
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def _get_cached_result(username: str, cache_time: datetime):
    # Return cached result if less than 1 hour old
    pass
```

### ะะพะฑะฐะฒะปะตะฝะธะต retry ะปะพะณะธะบะธ:

```python
from tenacity import retry, stop_after_attempt, wait_fixed

@retry(stop=stop_after_attempt(3), wait=wait_fixed(2))
async def check_account_hybrid_with_retry(...):
    return await check_account_hybrid(...)
```

### ะะพะฑะฐะฒะปะตะฝะธะต ะผะตััะธะบ:

```python
metrics = {
    "total_checks": 0,
    "api_checks": 0,
    "instagram_checks": 0,
    "hybrid_checks": 0,
    "errors": 0
}
```

## ะคะฐะนะปั

ะกะพะทะดะฐะฝะฝัะต ัะฐะนะปั:
- โ `project/services/hybrid_checker.py` (184 ัััะพะบะธ)
- โ `project/handlers/check_hybrid.py` (105 ัััะพะบ)

ะะฑะฝะพะฒะปะตะฝะฝัะต ัะฐะนะปั:
- โ `project/keyboards.py` (+1 ะบะฝะพะฟะบะฐ)
- โ `project/bot.py` (+88 ัััะพะบ ะพะฑัะฐะฑะพัะบะธ)

## ะะพะบัะผะตะฝัะฐัะธั

- โ `HYBRID_CHECK_GUIDE.md` - ะัะบะพะฒะพะดััะฒะพ ะฟะพะปัะทะพะฒะฐัะตะปั
- โ `HYBRID_IMPLEMENTATION.md` - ะขะตัะฝะธัะตัะบะฐั ะดะพะบัะผะตะฝัะฐัะธั (ััะพั ัะฐะนะป)

---

**ะกัะฐััั**: โ ะะพะปะฝะพัััั ัะตะฐะปะธะทะพะฒะฐะฝะพ ะธ ะณะพัะพะฒะพ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั  
**ะะฐัะฐ**: 2025-10-10  
**ะะตััะธั**: 1.0

