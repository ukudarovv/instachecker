# ะะฝัะตัะฐะบัะธะฒะฝัะต ัะฒะตะดะพะผะปะตะฝะธั ั ะบะฝะพะฟะบะฐะผะธ

## ะงัะพ ะธะทะผะตะฝะธะปะพัั

ะฃะฒะตะดะพะผะปะตะฝะธั ะพ ัะบะพัะพะผ ะธััะตัะตะฝะธะธ ััะพะบะฐ ะผะพะฝะธัะพัะธะฝะณะฐ ัะตะฟะตัั ัะพะดะตัะถะฐั ะธะฝัะตัะฐะบัะธะฒะฝัะต ะบะฝะพะฟะบะธ ะดะปั ะฑััััะพะณะพ ะดะพัััะฟะฐ ะบ ะธะฝัะพัะผะฐัะธะธ ะพะฑ ะฐะบะบะฐัะฝัะฐั.

## ะะพะฒะฐั ััะฝะบัะธะพะฝะฐะปัะฝะพััั

### 1. ะฃะฒะตะดะพะผะปะตะฝะธะต ั ะบะฝะพะฟะบะฐะผะธ

ะะผะตััะพ ัะตะบััะพะฒะพะณะพ ัะฟะธัะบะฐ ะฐะบะบะฐัะฝัะพะฒ, ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะปััะฐะตั ัะพะพะฑัะตะฝะธะต ั ะบะฝะพะฟะบะฐะผะธ:

```
โฐ ะะฐะฟะพะผะธะฝะฐะฝะธะต: ัะบะพัะพ ะธััะตัะตั ััะพะบ ะผะพะฝะธัะพัะธะฝะณะฐ

๐ ะะฐะนะดะตะฝะพ ะฐะบะบะฐัะฝัะพะฒ: 3

๐ก ะะตะบะพะผะตะฝะดะฐัะธั: ะฃะฒะตะปะธัััะต ะฟะตัะธะพะด ะผะพะฝะธัะพัะธะฝะณะฐ ะทะฐัะฐะฝะตะต

๐ ะะฐะถะผะธัะต ะฝะฐ ะบะฝะพะฟะบั ั ะฐะบะบะฐัะฝัะพะผ ะดะปั ะฟัะพัะผะพััะฐ ะธะฝัะพัะผะฐัะธะธ:

[๐ @username1 (ะพััะฐะปะพัั 5 ะดะฝ.)]
[๐ @username2 (ะพััะฐะปะพัั 3 ะดะฝ.)]
[๐ @username3 (ะพััะฐะปะพัั 7 ะดะฝ.)]
[๐ฑ ะะตะฐะบัะธะฒะฝัะต ะฐะบะบะฐัะฝัั]
```

### 2. ะะฝัะพัะผะฐัะธั ะฟัะธ ะฝะฐะถะฐัะธะธ ะฝะฐ ะบะฝะพะฟะบั

ะัะธ ะฝะฐะถะฐัะธะธ ะฝะฐ ะบะฝะพะฟะบั ั ะฐะบะบะฐัะฝัะพะผ ะพัะบััะฒะฐะตััั **ััะฐะฝะดะฐััะฝะฐั ะบะฐััะพัะบะฐ ะฐะบะบะฐัะฝัะฐ**:

```
๐ค ะะบะบะฐัะฝั
โข username: @username1
โข ั: 2025-10-09
โข ะฟะตัะธะพะด (ะดะฝะตะน): 30
โข ะดะพ: 2025-11-08
โข ะพััะฐะปะพัั: 5
โข ััะฐััั: ๐ ะะฐ ะฟัะพะฒะตัะบะต / ะ ัะฐะฑะพัะต

[โ ะะตะฝั] [โ ะะตะฝั]
[๐ ะฃะดะฐะปะธัั]
[โฌ ะะฐะทะฐะด]
```

### 3. ะะตะนััะฒะธั ั ะฐะบะบะฐัะฝัะพะผ

ะััะผะพ ะธะท ัะฒะตะดะพะผะปะตะฝะธั ะผะพะถะฝะพ:
- โ **ะะพะฑะฐะฒะธัั ะดะฝะธ** (ะบะฝะพะฟะบะฐ "โ ะะตะฝั")
- โ **ะฃะฑัะฐัั ะดะฝะธ** (ะบะฝะพะฟะบะฐ "โ ะะตะฝั")
- โ **ะฃะดะฐะปะธัั ะฐะบะบะฐัะฝั** (ะบะฝะพะฟะบะฐ "๐ ะฃะดะฐะปะธัั")
- โ **ะะตัะฝััััั ะฝะฐะทะฐะด** (ะบะฝะพะฟะบะฐ "โฌ ะะฐะทะฐะด")

### 4. ะะฝะพะฟะบะฐ "ะะตะฐะบัะธะฒะฝัะต ะฐะบะบะฐัะฝัั"

ะัะธ ะฝะฐะถะฐัะธะธ ะฝะฐ ะบะฝะพะฟะบั "๐ฑ ะะตะฐะบัะธะฒะฝัะต ะฐะบะบะฐัะฝัั" ะพัะบััะฒะฐะตััั ะฟะพะปะฝัะน ัะฟะธัะพะบ ะฝะตะฐะบัะธะฒะฝัั ะฐะบะบะฐัะฝัะพะฒ ั ะฟะฐะณะธะฝะฐัะธะตะน:

```
๐ ะะตะฐะบัะธะฒะฝัะต ะฐะบะบะฐัะฝัั (ะฝะฐ ะฟัะพะฒะตัะบะต)
ะกััะฐะฝะธัะฐ 1/2
ะัะตะณะพ: 15

[๐ @account1 โ]
[๐ @account2 โ]
...
[โฎ โ๏ธ 1/2 โถ๏ธ โญ]
```

## ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะกัะตะฝะฐัะธะน 1: ะัะพะดะปะตะฝะธะต ะฟะตัะธะพะดะฐ ะผะพะฝะธัะพัะธะฝะณะฐ

1. ะะพะปััะธะปะธ ัะฒะตะดะพะผะปะตะฝะธะต ั 3 ะฐะบะบะฐัะฝัะฐะผะธ
2. ะะฐะถะฐะปะธ ะฝะฐ `@username1 (ะพััะฐะปะพัั 5 ะดะฝ.)`
3. ะฃะฒะธะดะตะปะธ ะบะฐััะพัะบั ะฐะบะบะฐัะฝัะฐ
4. ะะฐะถะฐะปะธ `โ ะะตะฝั`
5. ะะฒะตะปะธ ะบะพะปะธัะตััะฒะพ ะดะฝะตะน: `30`
6. ะะตัะธะพะด ะฟัะพะดะปัะฝ! โ

### ะกัะตะฝะฐัะธะน 2: ะฃะดะฐะปะตะฝะธะต ะฝะตะฝัะถะฝะพะณะพ ะฐะบะบะฐัะฝัะฐ

1. ะะพะปััะธะปะธ ัะฒะตะดะพะผะปะตะฝะธะต
2. ะะฐะถะฐะปะธ ะฝะฐ ะฐะบะบะฐัะฝั
3. ะะฐะถะฐะปะธ `๐ ะฃะดะฐะปะธัั`
4. ะะพะดัะฒะตัะดะธะปะธ ัะดะฐะปะตะฝะธะต
5. ะะบะบะฐัะฝั ัะดะฐะปัะฝ! โ

### ะกัะตะฝะฐัะธะน 3: ะัะพัะผะพัั ะฒัะตั ะฝะตะฐะบัะธะฒะฝัั

1. ะะพะปััะธะปะธ ัะฒะตะดะพะผะปะตะฝะธะต
2. ะะฐะถะฐะปะธ `๐ฑ ะะตะฐะบัะธะฒะฝัะต ะฐะบะบะฐัะฝัั`
3. ะฃะฒะธะดะตะปะธ ะฒะตัั ัะฟะธัะพะบ ั ะฟะฐะณะธะฝะฐัะธะตะน
4. ะะพะถะฝะพ ะฟะตัะตะปะธัััะฒะฐัั ัััะฐะฝะธัั

## ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### ะะทะผะตะฝัะฝะฝัะต ัะฐะนะปั

#### 1. `project/services/expiry_notifications.py`

**ะคัะฝะบัะธั `send_expiring_soon_notification`**:
- ะกะพะทะดะฐัั ะธะฝัะตัะฐะบัะธะฒะฝัั ะบะปะฐะฒะธะฐัััั ะฒะผะตััะพ ัะตะบััะพะฒะพะณะพ ัะฟะธัะบะฐ
- ะะฐะถะดัะน ะฐะบะบะฐัะฝั = ะพัะดะตะปัะฝะฐั ะบะฝะพะฟะบะฐ ั callback
- ะคะพัะผะฐั callback: `expiry_soon:{account_id}`

```python
async def send_expiring_soon_notification(bot, user: User, accounts: List[Account]):
    # Create inline keyboard with buttons for each account
    keyboard = []
    for acc in accounts:
        days_left = (acc.to_date - date.today()).days
        button_text = f"@{acc.account} (ะพััะฐะปะพัั {days_left} ะดะฝ.)"
        keyboard.append([{
            "text": button_text,
            "callback_data": f"expiry_soon:{acc.id}"
        }])
    
    # Add "Manage accounts" button
    keyboard.append([{
        "text": "๐ฑ ะะตะฐะบัะธะฒะฝัะต ะฐะบะบะฐัะฝัั",
        "callback_data": "show_inactive_accounts"
    }])
    
    reply_markup = {"inline_keyboard": keyboard}
    await bot.send_message(user.id, message, reply_markup=reply_markup)
```

#### 2. `project/bot.py`

**ะะพะฒัะต ะพะฑัะฐะฑะพััะธะบะธ callback**:

1. **`expiry_soon:{account_id}`** - ะะพะบะฐะท ะธะฝัะพัะผะฐัะธะธ ะพะฑ ะฐะบะบะฐัะฝัะต
   - ะะพะปััะฐะตั ะฐะบะบะฐัะฝั ะฟะพ ID
   - ะคะพัะผะฐัะธััะตั ัะตัะตะท `format_account_card()`
   - ะะพะฑะฐะฒะปัะตั ะบะฝะพะฟะบะธ ะดะตะนััะฒะธะน (โโ๐โฌ)

2. **`show_inactive_accounts`** - ะะพะบะฐะท ัะฟะธัะบะฐ ะฝะตะฐะบัะธะฒะฝัั
   - ะะพะปััะฐะตั ะฟะตัะฒัั ัััะฐะฝะธัั ะฝะตะฐะบัะธะฒะฝัั ะฐะบะบะฐัะฝัะพะฒ
   - ะกะพะทะดะฐัั ะฟะฐะณะธะฝะฐัะธั
   - ะะพะบะฐะทัะฒะฐะตั ัะฟะธัะพะบ ั ะบะฝะพะฟะบะฐะผะธ

3. **`close_expiry_info`** - ะะฐะบัััะธะต ะบะฐััะพัะบะธ
   - ะฃะดะฐะปัะตั ัะพะพะฑัะตะฝะธะต ั ะธะฝัะพัะผะฐัะธะตะน

```python
elif callback_data.startswith("expiry_soon:"):
    # Show account info from expiry notification
    acc_id = int(callback_data.split(":")[1])
    
    with session_factory() as s:
        acc = get_account_by_id(s, acc_id)
        
        if not acc or acc.user_id != user.id:
            self.answer_callback_query(callback_query["id"], "โ ะะบะบะฐัะฝั ะฝะต ะฝะฐะนะดะตะฝ", show_alert=True)
            return
        
        # Format account info
        info_text = format_account_card(acc)
        
        # Create keyboard with action buttons
        keyboard = {
            "inline_keyboard": [
                [
                    {"text": "โ ะะตะฝั", "callback_data": f"addd:{acc_id}"},
                    {"text": "โ ะะตะฝั", "callback_data": f"subd:{acc_id}"}
                ],
                [{"text": "๐ ะฃะดะฐะปะธัั", "callback_data": f"delc:{acc_id}"}],
                [{"text": "โฌ ะะฐะทะฐะด", "callback_data": "close_expiry_info"}]
            ]
        }
        
        # Edit message with account info
        self.edit_message_text(chat_id, message_id, info_text, keyboard)
        self.answer_callback_query(callback_query["id"])
```

## Callback ััะตะผะฐ

```
ะฃะฒะตะดะพะผะปะตะฝะธะต
    โโ expiry_soon:{acc_id} โ ะะฐััะพัะบะฐ ะฐะบะบะฐัะฝัะฐ
    โ   โโ addd:{acc_id} โ ะะพะฑะฐะฒะธัั ะดะฝะธ (FSM)
    โ   โโ subd:{acc_id} โ ะฃะฑัะฐัั ะดะฝะธ (FSM)
    โ   โโ delc:{acc_id} โ ะฃะดะฐะปะธัั (ะฟะพะดัะฒะตัะถะดะตะฝะธะต)
    โ   โโ close_expiry_info โ ะะฐะบัััั/ะฃะดะฐะปะธัั
    โ
    โโ show_inactive_accounts โ ะกะฟะธัะพะบ ะฝะตะฐะบัะธะฒะฝัั
        โโ iinfo:{acc_id} โ ะะฐััะพัะบะฐ ะฐะบะบะฐัะฝัะฐ ะธะท ัะฟะธัะบะฐ
```

## ะัะตะธะผััะตััะฒะฐ

โ **ะฃะดะพะฑััะฒะพ**: ะัั ะธะฝัะพัะผะฐัะธั ะฒ ะพะดะฝะพะผ ัะพะพะฑัะตะฝะธะธ  
โ **ะััััะพัะฐ**: ะะต ะฝัะถะฝะพ ะธัะบะฐัั ะฐะบะบะฐัะฝัั ะฒ ะผะตะฝั  
โ **ะะฐะณะปัะดะฝะพััั**: ะะธะดะฝะพ ะบะพะปะธัะตััะฒะพ ะพััะฐะฒัะธััั ะดะฝะตะน  
โ **ะะตะนััะฒะธั**: ะะพะถะฝะพ ััะฐะทั ะฟัะพะดะปะธัั ะธะปะธ ัะดะฐะปะธัั  
โ **UX**: ะกะพะฒัะตะผะตะฝะฝัะน ะธะฝัะตััะตะนั ั inline ะบะฝะพะฟะบะฐะผะธ  

## ะะฑัะฐัะฝะฐั ัะพะฒะผะตััะธะผะพััั

โ ะฃะฒะตะดะพะผะปะตะฝะธั ะพะฑ ะธััะตะบัะตะผ ััะพะบะต ะพััะฐัััั ัะตะบััะพะฒัะผะธ (ะดะปั ะฐะบัะตะฝัะฐ ะฝะฐ ะฒะฐะถะฝะพััะธ)  
โ ะัะต ัััะตััะฒัััะธะต callback ะพะฑัะฐะฑะพััะธะบะธ ัะฐะฑะพัะฐัั ะฑะตะท ะธะทะผะตะฝะตะฝะธะน  
โ ะกัะฐะฝะดะฐััะฝัะต ะผะตะฝั ะฑะพัะฐ ะฝะต ะทะฐััะพะฝััั  

## ะะธะทัะฐะปัะฝัะน ะฟัะธะผะตั

### ะะพ:
```
โฐ ะะฐะฟะพะผะธะฝะฐะฝะธะต: ัะบะพัะพ ะธััะตัะตั ััะพะบ ะผะพะฝะธัะพัะธะฝะณะฐ

๐ ะกะปะตะดัััะธะต ะฐะบะบะฐัะฝัั ัะบะพัะพ ะดะพััะธะณะฝัั ะบะพะฝัะฐ ะฟะตัะธะพะดะฐ:
โข @username1 (ะพััะฐะปะพัั 5 ะดะฝ.)
โข @username2 (ะพััะฐะปะพัั 3 ะดะฝ.)
โข @username3 (ะพััะฐะปะพัั 7 ะดะฝ.)

๐ก ะะตะบะพะผะตะฝะดะฐัะธั: ะฃะฒะตะปะธัััะต ะฟะตัะธะพะด ะผะพะฝะธัะพัะธะฝะณะฐ ะทะฐัะฐะฝะตะต

๐ฑ ะัะฟะพะปัะทัะนัะต ะบะฝะพะฟะบั 'ะะตะฐะบัะธะฒะฝัะต ะฐะบะบะฐัะฝัั' ะดะปั ัะฟัะฐะฒะปะตะฝะธั
```

### ะะพัะปะต:
```
โฐ ะะฐะฟะพะผะธะฝะฐะฝะธะต: ัะบะพัะพ ะธััะตัะตั ััะพะบ ะผะพะฝะธัะพัะธะฝะณะฐ

๐ ะะฐะนะดะตะฝะพ ะฐะบะบะฐัะฝัะพะฒ: 3

๐ก ะะตะบะพะผะตะฝะดะฐัะธั: ะฃะฒะตะปะธัััะต ะฟะตัะธะพะด ะผะพะฝะธัะพัะธะฝะณะฐ ะทะฐัะฐะฝะตะต

๐ ะะฐะถะผะธัะต ะฝะฐ ะบะฝะพะฟะบั ั ะฐะบะบะฐัะฝัะพะผ ะดะปั ะฟัะพัะผะพััะฐ ะธะฝัะพัะผะฐัะธะธ:

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ @username1 (ะพััะฐะปะพัั 5 ะดะฝ.)      โ  โ ะะฝะพะฟะบะฐ 1
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ @username2 (ะพััะฐะปะพัั 3 ะดะฝ.)      โ  โ ะะฝะพะฟะบะฐ 2
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ @username3 (ะพััะฐะปะพัั 7 ะดะฝ.)      โ  โ ะะฝะพะฟะบะฐ 3
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ฑ ะะตะฐะบัะธะฒะฝัะต ะฐะบะบะฐัะฝัั           โ  โ ะะฝะพะฟะบะฐ "ะัะต"
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะะฐัะฐ ะพะฑะฝะพะฒะปะตะฝะธั

16 ะพะบััะฑัั 2025

