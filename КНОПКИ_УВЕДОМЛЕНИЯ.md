# Интерактивные уведомления с кнопками

## Что изменилось

Уведомления о скором истечении срока мониторинга теперь содержат интерактивные кнопки для быстрого доступа к информации об аккаунтах.

## Новая функциональность

### 1. Уведомление с кнопками

Вместо текстового списка аккаунтов, пользователь получает сообщение с кнопками:

```
⏰ Напоминание: скоро истечет срок мониторинга

📅 Найдено аккаунтов: 3

💡 Рекомендация: Увеличьте период мониторинга заранее

👇 Нажмите на кнопку с аккаунтом для просмотра информации:

[🔘 @username1 (осталось 5 дн.)]
[🔘 @username2 (осталось 3 дн.)]
[🔘 @username3 (осталось 7 дн.)]
[📱 Неактивные аккаунты]
```

### 2. Информация при нажатии на кнопку

При нажатии на кнопку с аккаунтом открывается **стандартная карточка аккаунта**:

```
👤 Аккаунт
• username: @username1
• с: 2025-10-09
• период (дней): 30
• до: 2025-11-08
• осталось: 5
• статус: 🕒 На проверке / В работе

[➕ День] [➖ День]
[🗑 Удалить]
[⬅ Назад]
```

### 3. Действия с аккаунтом

Прямо из уведомления можно:
- ✅ **Добавить дни** (кнопка "➕ День")
- ✅ **Убрать дни** (кнопка "➖ День")
- ✅ **Удалить аккаунт** (кнопка "🗑 Удалить")
- ✅ **Вернуться назад** (кнопка "⬅ Назад")

### 4. Кнопка "Неактивные аккаунты"

При нажатии на кнопку "📱 Неактивные аккаунты" открывается полный список неактивных аккаунтов с пагинацией:

```
📋 Неактивные аккаунты (на проверке)
Страница 1/2
Всего: 15

[🔘 @account1 →]
[🔘 @account2 →]
...
[⏮ ◀️ 1/2 ▶️ ⏭]
```

## Примеры использования

### Сценарий 1: Продление периода мониторинга

1. Получили уведомление с 3 аккаунтами
2. Нажали на `@username1 (осталось 5 дн.)`
3. Увидели карточку аккаунта
4. Нажали `➕ День`
5. Ввели количество дней: `30`
6. Период продлён! ✅

### Сценарий 2: Удаление ненужного аккаунта

1. Получили уведомление
2. Нажали на аккаунт
3. Нажали `🗑 Удалить`
4. Подтвердили удаление
5. Аккаунт удалён! ✅

### Сценарий 3: Просмотр всех неактивных

1. Получили уведомление
2. Нажали `📱 Неактивные аккаунты`
3. Увидели весь список с пагинацией
4. Можно перелистывать страницы

## Технические детали

### Изменённые файлы

#### 1. `project/services/expiry_notifications.py`

**Функция `send_expiring_soon_notification`**:
- Создаёт интерактивную клавиатуру вместо текстового списка
- Каждый аккаунт = отдельная кнопка с callback
- Формат callback: `expiry_soon:{account_id}`

```python
async def send_expiring_soon_notification(bot, user: User, accounts: List[Account]):
    # Create inline keyboard with buttons for each account
    keyboard = []
    for acc in accounts:
        days_left = (acc.to_date - date.today()).days
        button_text = f"@{acc.account} (осталось {days_left} дн.)"
        keyboard.append([{
            "text": button_text,
            "callback_data": f"expiry_soon:{acc.id}"
        }])
    
    # Add "Manage accounts" button
    keyboard.append([{
        "text": "📱 Неактивные аккаунты",
        "callback_data": "show_inactive_accounts"
    }])
    
    reply_markup = {"inline_keyboard": keyboard}
    await bot.send_message(user.id, message, reply_markup=reply_markup)
```

#### 2. `project/bot.py`

**Новые обработчики callback**:

1. **`expiry_soon:{account_id}`** - Показ информации об аккаунте
   - Получает аккаунт по ID
   - Форматирует через `format_account_card()`
   - Добавляет кнопки действий (➕➖🗑⬅)

2. **`show_inactive_accounts`** - Показ списка неактивных
   - Получает первую страницу неактивных аккаунтов
   - Создаёт пагинацию
   - Показывает список с кнопками

3. **`close_expiry_info`** - Закрытие карточки
   - Удаляет сообщение с информацией

```python
elif callback_data.startswith("expiry_soon:"):
    # Show account info from expiry notification
    acc_id = int(callback_data.split(":")[1])
    
    with session_factory() as s:
        acc = get_account_by_id(s, acc_id)
        
        if not acc or acc.user_id != user.id:
            self.answer_callback_query(callback_query["id"], "❌ Аккаунт не найден", show_alert=True)
            return
        
        # Format account info
        info_text = format_account_card(acc)
        
        # Create keyboard with action buttons
        keyboard = {
            "inline_keyboard": [
                [
                    {"text": "➕ День", "callback_data": f"addd:{acc_id}"},
                    {"text": "➖ День", "callback_data": f"subd:{acc_id}"}
                ],
                [{"text": "🗑 Удалить", "callback_data": f"delc:{acc_id}"}],
                [{"text": "⬅ Назад", "callback_data": "close_expiry_info"}]
            ]
        }
        
        # Edit message with account info
        self.edit_message_text(chat_id, message_id, info_text, keyboard)
        self.answer_callback_query(callback_query["id"])
```

## Callback схема

```
Уведомление
    ├─ expiry_soon:{acc_id} → Карточка аккаунта
    │   ├─ addd:{acc_id} → Добавить дни (FSM)
    │   ├─ subd:{acc_id} → Убрать дни (FSM)
    │   ├─ delc:{acc_id} → Удалить (подтверждение)
    │   └─ close_expiry_info → Закрыть/Удалить
    │
    └─ show_inactive_accounts → Список неактивных
        └─ iinfo:{acc_id} → Карточка аккаунта из списка
```

## Преимущества

✅ **Удобство**: Вся информация в одном сообщении  
✅ **Быстрота**: Не нужно искать аккаунты в меню  
✅ **Наглядность**: Видно количество оставшихся дней  
✅ **Действия**: Можно сразу продлить или удалить  
✅ **UX**: Современный интерфейс с inline кнопками  

## Обратная совместимость

✅ Уведомления об истекшем сроке остаются текстовыми (для акцента на важности)  
✅ Все существующие callback обработчики работают без изменений  
✅ Стандартные меню бота не затронуты  

## Визуальный пример

### До:
```
⏰ Напоминание: скоро истечет срок мониторинга

📅 Следующие аккаунты скоро достигнут конца периода:
• @username1 (осталось 5 дн.)
• @username2 (осталось 3 дн.)
• @username3 (осталось 7 дн.)

💡 Рекомендация: Увеличьте период мониторинга заранее

📱 Используйте кнопку 'Неактивные аккаунты' для управления
```

### После:
```
⏰ Напоминание: скоро истечет срок мониторинга

📅 Найдено аккаунтов: 3

💡 Рекомендация: Увеличьте период мониторинга заранее

👇 Нажмите на кнопку с аккаунтом для просмотра информации:

┌──────────────────────────────────┐
│ @username1 (осталось 5 дн.)      │  ← Кнопка 1
├──────────────────────────────────┤
│ @username2 (осталось 3 дн.)      │  ← Кнопка 2
├──────────────────────────────────┤
│ @username3 (осталось 7 дн.)      │  ← Кнопка 3
├──────────────────────────────────┤
│ 📱 Неактивные аккаунты           │  ← Кнопка "Все"
└──────────────────────────────────┘
```

## Дата обновления

16 октября 2025

