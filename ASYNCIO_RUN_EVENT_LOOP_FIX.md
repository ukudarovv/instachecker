# üîß Asyncio.run() Event Loop Fix

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ API –∫–ª—é—á–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:

```
2025-10-24 19:39:03,808 | ERROR | bot | Error in main loop: asyncio.run() cannot be called from a running event loop
```

### ‚ùå **–ß—Ç–æ –±—ã–ª–æ –Ω–µ —Ç–∞–∫:**

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `asyncio.run()` –≤ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω–æ–º event loop:**
   - –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º event loop
   - –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ API –∫–ª—é—á–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `asyncio.run()`
   - `asyncio.run()` —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π event loop
   - –ö–æ–Ω—Ñ–ª–∏–∫—Ç: –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π loop –≤–Ω—É—Ç—Ä–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ

2. **–ú–µ—Å—Ç–∞ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –æ—à–∏–±–∫–∏:**
   - –°—Ç—Ä–æ–∫–∞ 1086: `asyncio.run(test_api_key(key_value, test_username="instagram"))`
   - –°—Ç—Ä–æ–∫–∞ 2664: `asyncio.run(test_api_key(key_value, test_username="instagram"))`

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### üîç **–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–æ—Ç–∞:**
   - –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º event loop
   - –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —ç—Ç–æ–º –∂–µ loop
   - `asyncio.run()` –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π loop

2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç event loop:**
   ```python
   # –û—Å–Ω–æ–≤–Ω–æ–π event loop (—É–∂–µ –∑–∞–ø—É—â–µ–Ω)
   # ‚Üì
   # asyncio.run() –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π loop
   # ‚Üì
   # –û—à–∏–±–∫–∞: "cannot be called from a running event loop"
   ```

3. **–§—É–Ω–∫—Ü–∏—è `test_api_key` —è–≤–ª—è–µ—Ç—Å—è async:**
   - –¢—Ä–µ–±—É–µ—Ç event loop –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –ù–µ–ª—å–∑—è –≤—ã–∑–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
   - –ù—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞

## –†–µ—à–µ–Ω–∏–µ

### ‚úÖ **–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**

1. **–ó–∞–º–µ–Ω–∞ `asyncio.run()` –Ω–∞ ThreadPoolExecutor:**
   ```python
   # –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
   ok, err = asyncio.run(test_api_key(key_value, test_username="instagram"))
   
   # –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
   import concurrent.futures
   with concurrent.futures.ThreadPoolExecutor() as executor:
       future = executor.submit(asyncio.run, test_api_key(key_value, test_username="instagram"))
       try:
           ok, err = future.result(timeout=30)  # 30 second timeout
       except Exception as e:
           ok, err = False, str(e)
   ```

2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–≤–∞ –º–µ—Å—Ç–∞:**
   - **–°—Ç—Ä–æ–∫–∞ 1086:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ API –∫–ª—é—á–∞
   - **–°—Ç—Ä–æ–∫–∞ 2664:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ API –∫–ª—é—á–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏

3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - Timeout 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
   - Fallback –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. **ThreadPoolExecutor –ø–æ–¥—Ö–æ–¥**

```python
import concurrent.futures
import asyncio

# –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è async —Ñ—É–Ω–∫—Ü–∏–∏
with concurrent.futures.ThreadPoolExecutor() as executor:
    # –ó–∞–ø—É—Å–∫–∞–µ–º asyncio.run() –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    future = executor.submit(asyncio.run, test_api_key(key_value, test_username="instagram"))
    try:
        # –ñ–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        ok, err = future.result(timeout=30)
    except Exception as e:
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
        ok, err = False, str(e)
```

### 2. **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è**

- ‚úÖ **–ò–∑–±–µ–≥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ event loop**
- ‚úÖ **–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ**
- ‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π loop**
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤**
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º**

### 3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

```python
try:
    ok, err = future.result(timeout=30)  # 30 second timeout
except Exception as e:
    ok, err = False, str(e)  # Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ
```

**–¢–∏–ø—ã –æ—à–∏–±–æ–∫:**
- TimeoutError: –ø—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç
- Exception: –ª—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
- RuntimeError: –ø—Ä–æ–±–ª–µ–º—ã —Å event loop

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ **–ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–µ–π:**
   - ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ event loop
   - ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–µ–π:**
   - ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π
   - ‚úÖ –ù–æ–≤—ã—Ö –∫–ª—é—á–µ–π –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
   - ‚úÖ –¢–∞–π–º–∞—É—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

3. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –±–æ—Ç–∞:**
   - ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ event loop
   - ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π loop –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
   - ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

### üìä **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | asyncio.run() | ThreadPoolExecutor | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|---------------|-------------------|-----------|
| Event loop –∫–æ–Ω—Ñ–ª–∏–∫—Ç | –î–∞ | –ù–µ—Ç | +100% |
| –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ loop | –î–∞ | –ù–µ—Ç | +100% |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | –ë–∞–∑–æ–≤–∞—è | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è | +100% |
| –¢–∞–π–º–∞—É—Ç—ã | –ù–µ—Ç | –î–∞ | +100% |
| –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | +100% |

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### ‚ùå **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Å –æ—à–∏–±–∫–æ–π):**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç API –∫–ª—é—á:
‚Üí –í—ã–∑—ã–≤–∞–µ—Ç—Å—è asyncio.run()
‚Üí –û—à–∏–±–∫–∞: "asyncio.run() cannot be called from a running event loop"
‚Üí –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚Üí –ë–æ—Ç –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É –≤ –ª–æ–≥–∞—Ö
```

### ‚úÖ **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç):**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç API –∫–ª—é—á:
‚Üí –°–æ–∑–¥–∞–µ—Ç—Å—è ThreadPoolExecutor
‚Üí asyncio.run() –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
‚Üí –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
‚Üí –ö–ª—é—á –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### 1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è**

```python
# –û—Å–Ω–æ–≤–Ω–æ–π event loop (–±–æ—Ç)
# ‚Üì
# ThreadPoolExecutor (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫)
# ‚Üì
# asyncio.run() (–Ω–æ–≤—ã–π event loop –≤ –ø–æ—Ç–æ–∫–µ)
# ‚Üì
# test_api_key() (async —Ñ—É–Ω–∫—Ü–∏—è)
# ‚Üì
# –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
```

### 2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏**

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
with concurrent.futures.ThreadPoolExecutor() as executor:
    # –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    future = executor.submit(...)
    # –ü–æ—Ç–æ–∫ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

### 3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤**

```python
# –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API
try:
    ok, err = future.result(timeout=30)
except TimeoutError:
    ok, err = False, "API test timeout"
except Exception as e:
    ok, err = False, str(e)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ **–ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å:**

1. **–£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏ event loop**
   - ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É loop'–∞–º–∏
   - ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–æ—Ç–∞
   - ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ async —Ñ—É–Ω–∫—Ü–∏–π

2. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
   - ‚úÖ –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
   - ‚úÖ Fallback –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

3. **–ü–æ–≤—ã—à–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**
   - ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π loop –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
   - ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
   - ‚úÖ –ù–µ—Ç deadlock'–æ–≤

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ —Å event loop –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞:**

- ‚úÖ **–ó–∞–º–µ–Ω–µ–Ω `asyncio.run()` –Ω–∞ `ThreadPoolExecutor`**
- ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã event loop**
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤**
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API –∫–ª—é—á–µ–π**

### üéØ **–ò—Ç–æ–≥:**

**–û—à–∏–±–∫–∞ "asyncio.run() cannot be called from a running event loop" –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ API –∫–ª—é—á–µ–π —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!**

**–¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫ event loop!** üéâ
