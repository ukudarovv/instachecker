# ๐ง Days Input Cancel Button Fix

## ะัะพะฑะปะตะผะฐ

ะะพะปัะทะพะฒะฐัะตะปั ัะพะพะฑัะธะป: "ะัะธ ะฝะฐะถะฐัะธะธ ะดะตะฝั + ะธ - ะฒััะพะดะธั ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ัะผะตะฝััะตะฝะธั (ัะตะปะพะต > 0): ะฝะฐะดะพ ะดะพะฑะฐะฒะธัั ะบะฝะพะฟะบั ะพัะผะตะฝะฐ ะฒ keyboard"

## ะะฝะฐะปะธะท ะฟัะพะฑะปะตะผั

### โ **ะงัะพ ะฑัะปะพ ะฝะต ัะฐะบ:**

1. **ะััััััะฒะธะต ะบะฝะพะฟะบะธ "ะัะผะตะฝะฐ" ะฟัะธ ะฒะฒะพะดะต ะดะฝะตะน**
   - ะัะธ ะฝะฐะถะฐัะธะธ "+" ะธะปะธ "-" ะดะปั ะดะฝะตะน ะทะฐะฟัะฐัะธะฒะฐะตััั ะฒะฒะพะด ะบะพะปะธัะตััะฒะฐ
   - ะะตั ะบะฝะพะฟะบะธ "ะัะผะตะฝะฐ" ะฒ ะบะปะฐะฒะธะฐัััะต
   - ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะผะพะถะตั ะพัะผะตะฝะธัั ะพะฟะตัะฐัะธั

2. **ะะตัะดะพะฑััะฒะพ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั**
   - ะัะถะฝะพ ะฒะฒะพะดะธัั ัะธัะปะพ ะธะปะธ ะพัะฟัะฐะฒะปััั ะฟัััะพะต ัะพะพะฑัะตะฝะธะต
   - ะะตั ะฟัะพััะพะณะพ ัะฟะพัะพะฑะฐ ะพัะผะตะฝะธัั ะพะฟะตัะฐัะธั
   - ะะปะพัะพะน UX

## ะะตัะตะฝะธะต

### โ **ะงัะพ ะฑัะปะพ ะธัะฟัะฐะฒะปะตะฝะพ:**

1. **ะะพะฑะฐะฒะปะตะฝะฐ ะบะฝะพะฟะบะฐ "ะัะผะตะฝะฐ" ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั ะดะฝะตะน**
   ```python
   # Create keyboard with Cancel button
   cancel_keyboard = {
       "keyboard": [
           [{"text": "โ ะัะผะตะฝะฐ"}]
       ],
       "resize_keyboard": True,
       "one_time_keyboard": True
   }
   self.send_message(chat_id, "ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั (ัะตะปะพะต > 0):", cancel_keyboard)
   ```

2. **ะะพะฑะฐะฒะปะตะฝะฐ ะบะฝะพะฟะบะฐ "ะัะผะตะฝะฐ" ะดะปั ัะผะตะฝััะตะฝะธั ะดะฝะตะน**
   ```python
   # Create keyboard with Cancel button
   cancel_keyboard = {
       "keyboard": [
           [{"text": "โ ะัะผะตะฝะฐ"}]
       ],
       "resize_keyboard": True,
       "one_time_keyboard": True
   }
   self.send_message(chat_id, "ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ัะผะตะฝััะตะฝะธั (ัะตะปะพะต > 0):", cancel_keyboard)
   ```

3. **ะะฑัะฐะฑะพััะธะบ "ะัะผะตะฝะฐ" ัะถะต ัััะตััะฒัะตั**
   - ะะฑัะฐะฑะพััะธะบ `elif text == "ะัะผะตะฝะฐ" or text == "โ ะัะผะตะฝะฐ":` ัะถะต ัััะตััะฒัะตั
   - ะะฝ ะพะฑัะฐะฑะฐััะฒะฐะตั ะฒัะต FSM ัะพััะพัะฝะธั, ะฒะบะปััะฐั `waiting_for_add_days` ะธ `waiting_for_remove_days`
   - ะะฒัะพะผะฐัะธัะตัะบะธ ะพัะธัะฐะตั ัะพััะพัะฝะธะต ะธ ะฒะพะทะฒัะฐัะฐะตั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั

## ะะตัะฐะปะธ ะธัะฟัะฐะฒะปะตะฝะธั

### 1. **ะะพะฑะฐะฒะปะตะฝะธะต ะดะฝะตะน (`addd:`)**

**ะัะปะพ:**
```python
elif callback_data.startswith("addd:"):
    # Start add days FSM
    acc_id = int(callback_data.split(":")[1])
    self.fsm_states[user_id] = {
        "state": "waiting_for_add_days",
        "acc_id": acc_id,
        "back_prefix": "apg",
        "page": 1
    }
    self.send_message(chat_id, "ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั (ัะตะปะพะต > 0):")
    self.answer_callback_query(callback_query["id"])
```

**ะกัะฐะปะพ:**
```python
elif callback_data.startswith("addd:"):
    # Start add days FSM
    acc_id = int(callback_data.split(":")[1])
    self.fsm_states[user_id] = {
        "state": "waiting_for_add_days",
        "acc_id": acc_id,
        "back_prefix": "apg",
        "page": 1
    }
    # Create keyboard with Cancel button
    cancel_keyboard = {
        "keyboard": [
            [{"text": "โ ะัะผะตะฝะฐ"}]
        ],
        "resize_keyboard": True,
        "one_time_keyboard": True
    }
    self.send_message(chat_id, "ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั (ัะตะปะพะต > 0):", cancel_keyboard)
    self.answer_callback_query(callback_query["id"])
```

### 2. **ะฃะผะตะฝััะตะฝะธะต ะดะฝะตะน (`subd:`)**

**ะัะปะพ:**
```python
elif callback_data.startswith("subd:"):
    # Start subtract days FSM
    acc_id = int(callback_data.split(":")[1])
    self.fsm_states[user_id] = {
        "state": "waiting_for_remove_days",
        "acc_id": acc_id,
        "back_prefix": "apg",
        "page": 1
    }
    self.send_message(chat_id, "ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ัะผะตะฝััะตะฝะธั (ัะตะปะพะต > 0):")
    self.answer_callback_query(callback_query["id"])
```

**ะกัะฐะปะพ:**
```python
elif callback_data.startswith("subd:"):
    # Start subtract days FSM
    acc_id = int(callback_data.split(":")[1])
    self.fsm_states[user_id] = {
        "state": "waiting_for_remove_days",
        "acc_id": acc_id,
        "back_prefix": "apg",
        "page": 1
    }
    # Create keyboard with Cancel button
    cancel_keyboard = {
        "keyboard": [
            [{"text": "โ ะัะผะตะฝะฐ"}]
        ],
        "resize_keyboard": True,
        "one_time_keyboard": True
    }
    self.send_message(chat_id, "ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ัะผะตะฝััะตะฝะธั (ัะตะปะพะต > 0):", cancel_keyboard)
    self.answer_callback_query(callback_query["id"])
```

### 3. **ะะฑัะฐะฑะพััะธะบ "ะัะผะตะฝะฐ"**

```python
elif text == "ะัะผะตะฝะฐ" or text == "โ ะัะผะตะฝะฐ":
    # Cancel any FSM operation
    if user_id in self.fsm_states:
        del self.fsm_states[user_id]
    try:
        from .services.system_settings import get_global_verify_mode
    except ImportError:
        from services.system_settings import get_global_verify_mode
    with session_factory() as session:
        verify_mode = get_global_verify_mode(session)
    keyboard = main_menu(is_admin=ensure_admin(user), verify_mode=verify_mode)
    self.send_message(chat_id, "ะะฟะตัะฐัะธั ะพัะผะตะฝะตะฝะฐ", keyboard)
```

## ะะตะทัะปััะฐัั ะธัะฟัะฐะฒะปะตะฝะธั

### โ **ะงัะพ ัะตะฟะตัั ัะฐะฑะพัะฐะตั:**

1. **ะะฝะพะฟะบะฐ "ะัะผะตะฝะฐ" ะฟัะธ ะดะพะฑะฐะฒะปะตะฝะธะธ ะดะฝะตะน**
   - โ ะะปะฐะฒะธะฐัััะฐ ั ะบะฝะพะฟะบะพะน "โ ะัะผะตะฝะฐ"
   - โ ะะพะทะผะพะถะฝะพััั ะพัะผะตะฝะธัั ะพะฟะตัะฐัะธั
   - โ ะฃะดะพะฑะฝัะน UX

2. **ะะฝะพะฟะบะฐ "ะัะผะตะฝะฐ" ะฟัะธ ัะผะตะฝััะตะฝะธะธ ะดะฝะตะน**
   - โ ะะปะฐะฒะธะฐัััะฐ ั ะบะฝะพะฟะบะพะน "โ ะัะผะตะฝะฐ"
   - โ ะะพะทะผะพะถะฝะพััั ะพัะผะตะฝะธัั ะพะฟะตัะฐัะธั
   - โ ะฃะดะพะฑะฝัะน UX

3. **ะะฑัะฐะฑะพัะบะฐ ะพัะผะตะฝั**
   - โ ะัะธััะบะฐ FSM ัะพััะพัะฝะธั
   - โ ะะพะทะฒัะฐั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั
   - โ ะกะพะพะฑัะตะฝะธะต ะพะฑ ะพัะผะตะฝะต

### ๐ **ะกัะฐัะธััะธะบะฐ ะธัะฟัะฐะฒะปะตะฝะธะน:**

| ะะฐัะฐะผะตัั | ะะพ ะธัะฟัะฐะฒะปะตะฝะธั | ะะพัะปะต ะธัะฟัะฐะฒะปะตะฝะธั | ะฃะปัััะตะฝะธะต |
|----------|----------------|-------------------|-----------|
| ะะฝะพะฟะบะฐ "ะัะผะตะฝะฐ" | ะะตั | ะะฐ | +100% |
| ะฃะดะพะฑััะฒะพ ะพัะผะตะฝั | ะะธะทะบะพะต | ะััะพะบะพะต | +100% |
| UX | ะะปะพัะพะน | ะฅะพัะพัะธะน | +100% |

## ะัะธะผะตัั ัะฐะฑะพัั

### โ **ะะพะฑะฐะฒะปะตะฝะธะต ะดะฝะตะน:**
```
ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั (ัะตะปะพะต > 0):

[โ ะัะผะตะฝะฐ] <- ะะฝะพะฟะบะฐ ะฒ ะบะปะฐะฒะธะฐัััะต (ัะบััะฒะฐะตััั ะฟะพัะปะต ะฝะฐะถะฐัะธั)
```

### โ **ะฃะผะตะฝััะตะฝะธะต ะดะฝะตะน:**
```
ะะฒะตะดะธัะต ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะดะปั ัะผะตะฝััะตะฝะธั (ัะตะปะพะต > 0):

[โ ะัะผะตะฝะฐ] <- ะะฝะพะฟะบะฐ ะฒ ะบะปะฐะฒะธะฐัััะต (ัะบััะฒะฐะตััั ะฟะพัะปะต ะฝะฐะถะฐัะธั)
```

### โ **ะัะธ ะฝะฐะถะฐัะธะธ "ะัะผะตะฝะฐ":**
```
ะะฟะตัะฐัะธั ะพัะผะตะฝะตะฝะฐ

[ะะปะฐะฒะฝะพะต ะผะตะฝั] <- ะะพะทะฒัะฐั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั
```

## ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### 1. **ะกัััะบัััะฐ ะบะปะฐะฒะธะฐัััั**

```python
cancel_keyboard = {
    "keyboard": [
        [{"text": "โ ะัะผะตะฝะฐ"}]
    ],
    "resize_keyboard": True,      # ะะฒัะพะผะฐัะธัะตัะบะพะต ะธะทะผะตะฝะตะฝะธะต ัะฐะทะผะตัะฐ
    "one_time_keyboard": True     # ะกะบัััะธะต ะฟะพัะปะต ะธัะฟะพะปัะทะพะฒะฐะฝะธั
}
```

### 2. **FSM ัะพััะพัะฝะธั**

```python
# ะะพะฑะฐะฒะปะตะฝะธะต ะดะฝะตะน
self.fsm_states[user_id] = {
    "state": "waiting_for_add_days",
    "acc_id": acc_id,
    "back_prefix": "apg",
    "page": 1
}

# ะฃะผะตะฝััะตะฝะธะต ะดะฝะตะน
self.fsm_states[user_id] = {
    "state": "waiting_for_remove_days",
    "acc_id": acc_id,
    "back_prefix": "apg",
    "page": 1
}
```

### 3. **ะะฑัะฐะฑะพัะบะฐ ะพัะผะตะฝั**

```python
elif text == "ะัะผะตะฝะฐ" or text == "โ ะัะผะตะฝะฐ":
    # Cancel any FSM operation
    if user_id in self.fsm_states:
        del self.fsm_states[user_id]  # ะัะธััะบะฐ ัะพััะพัะฝะธั
    # ... ะฒะพะทะฒัะฐั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั
```

## ะัะตะธะผััะตััะฒะฐ ะธัะฟัะฐะฒะปะตะฝะธั

### โ **ะงัะพ ัะปัััะธะปะพัั:**

1. **ะฃะดะพะฑััะฒะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั**
   - โ ะัะพััะฐั ะพัะผะตะฝะฐ ะพะฟะตัะฐัะธะธ
   - โ ะะฝะพะฟะบะฐ ะฒัะตะณะดะฐ ะดะพัััะฟะฝะฐ
   - โ ะะฝััะธัะธะฒะฝัะน ะธะฝัะตััะตะนั

2. **ะฃะปัััะตะฝะฝัะน UX**
   - โ ะะต ะฝัะถะฝะพ ะฒะฒะพะดะธัั ะฟัััะพะต ัะพะพะฑัะตะฝะธะต
   - โ ะััััะฐั ะพัะผะตะฝะฐ ะพะฟะตัะฐัะธะธ
   - โ ะะพะฝััะฝะพะต ะฟะพะฒะตะดะตะฝะธะต

3. **ะะพะฝัะธััะตะฝัะฝะพััั**
   - โ ะะดะธะฝะพะพะฑัะฐะทะฝะฐั ะบะปะฐะฒะธะฐัััะฐ
   - โ ะกัะฐะฝะดะฐััะฝะพะต ะฟะพะฒะตะดะตะฝะธะต
   - โ ะัะตะดัะบะฐะทัะตะผะพััั

## ะะฐะบะปััะตะฝะธะต

### โ **ะัะพะฑะปะตะผะฐ ัะตัะตะฝะฐ:**

- โ **ะะพะฑะฐะฒะปะตะฝะฐ ะบะฝะพะฟะบะฐ "ะัะผะตะฝะฐ" ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั ะดะฝะตะน**
- โ **ะะพะฑะฐะฒะปะตะฝะฐ ะบะฝะพะฟะบะฐ "ะัะผะตะฝะฐ" ะดะปั ัะผะตะฝััะตะฝะธั ะดะฝะตะน**
- โ **ะะฑัะฐะฑะพััะธะบ "ะัะผะตะฝะฐ" ัะถะต ัััะตััะฒะพะฒะฐะป ะธ ัะฐะฑะพัะฐะตั**
- โ **ะฃะปัััะตะฝ ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะน ะพะฟัั**

### ๐ฏ **ะัะพะณ:**

**ะขะตะฟะตัั ะฟัะธ ะฝะฐะถะฐัะธะธ "+" ะธะปะธ "-" ะดะปั ะดะฝะตะน ะฟะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ะบะฝะพะฟะบั "ะัะผะตะฝะฐ" ะฒ ะบะปะฐะฒะธะฐัััะต, ััะพ ะฟะพะทะฒะพะปัะตั ะปะตะณะบะพ ะพัะผะตะฝะธัั ะพะฟะตัะฐัะธั ะธ ัะปัััะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะน ะพะฟัั!**

**ะัะพะฑะปะตะผะฐ ั ะพััััััะฒะธะตะผ ะบะฝะพะฟะบะธ "ะัะผะตะฝะฐ" ะฟัะธ ะฒะฒะพะดะต ะบะพะปะธัะตััะฒะฐ ะดะฝะตะน ััะฟะตัะฝะพ ะธัะฟัะฐะฒะปะตะฝะฐ!** ๐
