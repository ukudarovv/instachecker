# Исправление проблемы Rate Limit Instagram

## Проблема

Из логов видно следующие проблемы:
1. Многие аккаунты определяются как "NOT FOUND", хотя сессии валидны
2. Instagram редиректит на главную страницу вместо профиля
3. Слишком частые запросы вызывают блокировку

## Внесенные изменения

### 1. `project/services/ig_simple_checker.py`

#### Увеличены задержки загрузки страницы
- Увеличена задержка с 2000ms до 3000ms после загрузки профиля
- Добавлено логирование URL после навигации

#### Добавлена обработка редиректа на главную страницу
```python
# Проверка редиректа на главную
if current_url == "https://www.instagram.com/" or current_url == "https://www.instagram.com":
    # Повторная попытка с задержкой
    await page.wait_for_timeout(2000)
    await page.goto(url, wait_until="domcontentloaded", timeout=timeout_ms)
    await page.wait_for_timeout(3000)
```

### 2. `project/cron/auto_checker.py`

#### Уменьшено количество параллельных проверок
- Изменено с 3 до 2 параллельных проверок
- Это снижает нагрузку на Instagram

#### Увеличена задержка между проверками
- Изменена с 2 секунд до 3 секунд
- Помогает избежать rate limiting

## Рекомендации

### Для предотвращения блокировок:

1. **Используйте несколько Instagram сессий**
   - Распределяйте проверки между разными аккаунтами
   - Ротируйте сессии

2. **Увеличьте интервал автопроверки**
   - Текущий интервал: 3 минуты
   - Рекомендуется: 5-10 минут для большого количества аккаунтов

3. **Используйте прокси** (опционально)
   - Меняйте IP-адреса между запросами
   - Снижает вероятность блокировки

### Если проблема сохраняется:

1. **Проверьте качество сессий**
   ```bash
   # В логах ищите:
   ✅ Sessionid cookie is valid for @username
   ```

2. **Увеличьте задержки еще больше**
   - В `ig_simple_checker.py`: увеличьте `wait_for_timeout`
   - В `auto_checker.py`: увеличьте `asyncio.sleep`

3. **Уменьшите параллельность до 1**
   ```python
   semaphore = asyncio.Semaphore(1)  # Только 1 проверка за раз
   ```

## Тестирование

После внесения изменений:

1. Перезапустите бота
2. Следите за логами:
   ```bash
   journalctl -u instagram-bot -f
   ```
3. Обратите внимание на:
   - Количество "NOT FOUND" должно уменьшиться
   - Меньше редиректов на главную страницу
   - Больше успешных проверок

## Статистика до изменений (из логов)

- Многие проверки: `❌ @username - NOT FOUND`
- Частые редиректы: `Current URL after navigation: https://www.instagram.com/`
- Параллельность: 3 проверки одновременно
- Задержка: 2 секунды

## Ожидаемые результаты

- ✅ Меньше ложных "NOT FOUND"
- ✅ Меньше редиректов
- ✅ Стабильные проверки без блокировок
- ⚠️ Немного медленнее (но надежнее)

